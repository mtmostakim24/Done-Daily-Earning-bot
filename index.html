<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Tycoon Bot | Premium Earning Platform</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ... (styles remain exactly as provided) ... */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding-bottom: 70px;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.3) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 18px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 320px;
    }

    .notification.show {
      transform: translateX(0);
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .notification.error {
      background: linear-gradient(135deg, #f44336, #e91e63);
    }

    .notification.warning {
      background: linear-gradient(135deg, #ff9800, #ff5722);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .title {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .title i {
      margin-right: 10px;
      font-size: 26px;
      color: #ffd700;
      animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .balance-display {
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.3));
      padding: 10px 18px;
      border-radius: 25px;
      font-weight: bold;
      border: 2px solid rgba(76, 175, 80, 0.5);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .profile-container {
      padding: 20px;
    }

    .profile {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 25px;
    }

    .profile-img-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 18px;
      border: 4px solid #ffd700;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      position: relative;
    }

    .profile-img-container::after {
      content: '‚úì';
      position: absolute;
      bottom: 0;
      right: 0;
      background: #4CAF50;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      border: 3px solid white;
    }

    .profile-img-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      flex: 1;
    }

    .name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 6px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .user-id {
      font-size: 14px;
      opacity: 0.9;
      background: rgba(0,0,0,0.2);
      padding: 4px 12px;
      border-radius: 12px;
      display: inline-block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .stat-item {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2));
      padding: 18px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .stat-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 8px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cards-container {
      padding: 0 20px 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideUp 0.5s ease-out;
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.15);
      padding-bottom: 15px;
    }

    .card-header i {
      font-size: 26px;
      margin-right: 12px;
      color: #ffd700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .card-header h3 {
      font-size: 19px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.15);
      border-radius: 10px;
    }

    .info-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .info-value {
      font-size: 15px;
      font-weight: bold;
      color: #ffd700;
    }

    .progress-container {
      background: rgba(0, 0, 0, 0.3);
      height: 12px;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A, #4CAF50);
      background-size: 200% 100%;
      border-radius: 10px;
      width: 0%;
      transition: width 0.5s ease;
      animation: shimmer 2s infinite;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .btn {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
      border: none;
      padding: 15px 24px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      display: block;
      width: 100%;
      text-align: center;
      transition: all 0.3s ease;
      margin-top: 15px;
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #2196F3, #0D47A1);
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
    }

    .btn-purple {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2);
      box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
    }

    .btn-navy {
      background: linear-gradient(135deg, #001f3f, #003366);
      box-shadow: 0 5px 15px rgba(0, 31, 63, 0.4);
    }

    .btn:disabled {
      background: linear-gradient(135deg, #9e9e9e, #757575);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 15px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #ffd700;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }

    select option {
      background: #2c3e50;
      color: white;
    }

    /* Home Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin: 20px 0;
    }

    .action-btn {
      flex: 1;
      padding: 18px;
      border-radius: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      color: white;
    }

    .action-btn.deposit {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }

    .action-btn.withdraw {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      box-shadow: 0 5px 15px rgba(52, 73, 94, 0.4);
    }

    .action-btn:hover {
      transform: translateY(-3px);
    }

    .action-btn i {
      margin-right: 8px;
    }

    /* Social Links */
    .social-links {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .social-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .social-item:hover {
      transform: translateY(-3px);
      background: rgba(0, 0, 0, 0.5);
    }

    .social-item i {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .social-item span {
      display: block;
      font-size: 12px;
    }

    .telegram { color: #0088cc; }
    .youtube { color: #ff0000; }
    .facebook { color: #3b5998; }

    /* Support Icon */
    .support-icon {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #25d366, #128C7E);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(37, 211, 102, 0.4);
      z-index: 99;
      transition: all 0.3s ease;
    }

    .support-icon:hover {
      transform: scale(1.1);
    }

    /* Job Item */
    .job-item {
      background: rgba(0,0,0,0.2);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .job-item:hover {
      transform: translateX(5px);
      background: rgba(0,0,0,0.3);
    }

    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .job-id {
      background: #ffd700;
      color: #333;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 12px;
    }

    .job-price {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
    }

    .job-price.high {
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }

    .timer-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .timer-badge i {
      color: #ffd700;
    }

    .job-footer {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .job-footer .btn {
      flex: 1;
      margin-top: 0;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-pending {
      background: #ff9800;
      color: white;
    }

    .status-active {
      background: #4CAF50;
      color: white;
    }

    .status-completed {
      background: #2196F3;
      color: white;
    }

    .status-expired {
      background: #f44336;
      color: white;
    }

    /* Admin Panel */
    .admin-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      overflow-y: auto;
      padding: 20px;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .admin-close {
      font-size: 30px;
      cursor: pointer;
      color: #ffd700;
    }

    .admin-section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .admin-section h3 {
      margin-bottom: 20px;
      color: #ffd700;
    }

    .admin-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .admin-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .admin-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .admin-link-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ffd700;
      background: rgba(0,0,0,0.5);
      color: white;
    }

    .admin-message-input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid #ffd700;
    }

    /* History Lists */
    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      background: rgba(0, 0, 0, 0.25);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .history-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-date {
      font-size: 11px;
      opacity: 0.7;
    }

    .history-type {
      font-size: 13px;
      font-weight: 600;
    }

    .history-amount {
      font-weight: bold;
    }

    .history-amount.positive {
      color: #4CAF50;
    }

    .history-amount.negative {
      color: #f44336;
    }

    .empty-history {
      text-align: center;
      padding: 30px;
      opacity: 0.7;
      font-style: italic;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 3px;
      background: #ffd700;
      transition: width 0.3s ease;
    }

    .nav-item.active::before {
      width: 60%;
    }

    .nav-item.active {
      color: #ffd700;
    }

    .nav-item i {
      display: block;
      font-size: 22px;
      margin-bottom: 4px;
    }

    .nav-item span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @media (max-width: 480px) {
      .title {
        font-size: 18px;
      }

      .balance-display {
        padding: 8px 14px;
        font-size: 14px;
      }

      .profile {
        padding: 20px;
      }

      .profile-img-container {
        width: 70px;
        height: 70px;
      }

      .stat-value {
        font-size: 20px;
      }

      .btn {
        padding: 12px 20px;
        font-size: 14px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .social-links {
        grid-template-columns: 1fr;
      }
    }

    /* Notice card style */
    .notice-card {
      background: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .notice-card i {
      font-size: 24px;
      color: #ffc107;
    }
    .notice-card p {
      margin: 0;
      font-size: 14px;
    }
    .notice-card strong {
      color: #ffc107;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Notification -->
    <div id="notification" class="notification">
      <i class="fas fa-check-circle"></i>
      <span id="notification-message"></span>
    </div>

    <!-- Header -->
    <header>
      <div class="title">
        <i class="fas fa-coins"></i>
        Task Tycoon Bot
      </div>
      <div class="balance-display">
        <i class="fas fa-wallet"></i>
        ‡ß≥<span id="header-balance">0.00</span>
      </div>
    </header>

    <!-- Support Icon -->
    <div class="support-icon" onclick="openSupport()">
      <i class="fab fa-whatsapp"></i>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-panel">
      <div class="admin-header">
        <h2>‚ö° Admin Panel</h2>
        <div class="admin-close" onclick="toggleAdminPanel()">‚úï</div>
      </div>

      <div class="admin-section">
        <h3>üìã Pending Jobs (Waiting for Approval)</h3>
        <div id="admin-pending-jobs"></div>
      </div>

      <div class="admin-section">
        <h3>üí≥ Deposit Requests</h3>
        <div id="admin-deposit-requests"></div>
      </div>

      <div class="admin-section">
        <h3>üí∞ Withdraw Requests</h3>
        <div id="admin-withdraw-requests"></div>
      </div>

      <div class="admin-section">
        <h3>‚úÖ Active Jobs</h3>
        <div id="admin-active-jobs"></div>
      </div>

      <div class="admin-section">
        <h3>‚ö†Ô∏è Expired Jobs (Not Updated)</h3>
        <div id="admin-expired-jobs"></div>
      </div>
    </div>

    <!-- Home Profile Section -->
    <div id="home-profile" class="profile-container">
      <div class="profile">
        <div class="profile-header">
          <div class="profile-img-container">
            <img id="profile-img" src="https://via.placeholder.com/80" alt="Profile">
          </div>
          <div class="profile-info">
            <div class="name" id="user-name">Loading...</div>
            <div class="user-id">ID: <span id="display-user-id">------</span></div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">‡ß≥<span id="today-earning">0.00</span></div>
            <div class="stat-label">Today's Earning</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">‡ß≥<span id="lifetime-earning">0.00</span></div>
            <div class="stat-label">Total Earned</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><span id="total-tasks">0</span></div>
            <div class="stat-label">Tasks Completed</div>
          </div>
          <div class="stat-item">
            <div class="stat-value"><span id="referral-count">0</span></div>
            <div class="stat-label">Referrals</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Home Content Section -->
    <div id="home-content" class="cards-container">
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="action-btn deposit" onclick="show('deposit')">
          <i class="fas fa-plus-circle"></i> Deposit
        </button>
        <button class="action-btn withdraw" onclick="show('withdraw')">
          <i class="fas fa-wallet"></i> Withdraw
        </button>
      </div>

      <!-- Social Links -->
      <div class="social-links">
        <div class="social-item" onclick="window.open('https://t.me/yourchannel')">
          <i class="fab fa-telegram telegram"></i>
          <span>Join Channel</span>
        </div>
        <div class="social-item" onclick="window.open('https://youtube.com/yourchannel')">
          <i class="fab fa-youtube youtube"></i>
          <span>Subscribe</span>
        </div>
        <div class="social-item" onclick="window.open('https://facebook.com/yourpage')">
          <i class="fab fa-facebook facebook"></i>
          <span>Follow Page</span>
        </div>
      </div>
    </div>

    <!-- Earn Section (Available Jobs) -->
    <div id="earn" class="cards-container" style="display: none;">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-tasks"></i>
          <h3>Available Jobs</h3>
        </div>
        <div id="available-jobs-list"></div>
      </div>
    </div>

    <!-- Post Job Section -->
    <div id="post-job" class="cards-container" style="display: none;">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-plus-circle"></i>
          <h3>Post a New Job</h3>
        </div>
        
        <div class="input-group">
          <label class="input-label">Adstera Smart Link</label>
          <input type="url" id="job-adstera-link" placeholder="https://www.adsteratpd.com/..." required>
        </div>

        <div class="input-group">
          <label class="input-label">Number of Tasks</label>
          <select id="job-tasks">
            <option value="1000">1,000 Tasks</option>
            <option value="2000">2,000 Tasks</option>
            <option value="3000">3,000 Tasks</option>
            <option value="5000">5,000 Tasks</option>
            <option value="7000">7,000 Tasks</option>
            <option value="10000">10,000 Tasks</option>
          </select>
        </div>

        <div class="input-group">
          <label class="input-label">Pay per Task (Minimum ‡ß≥0.050)</label>
          <input type="number" id="job-rate" value="0.050" min="0.050" step="0.001">
        </div>

        <div class="info-row">
          <span class="info-label">Subtotal (Tasks √ó Rate)</span>
          <span class="info-value" id="subtotal">‡ß≥50.00</span>
        </div>
        <div class="info-row">
          <span class="info-label">Service Charge (+10%)</span>
          <span class="info-value" id="service-charge">‡ß≥5.00</span>
        </div>
        <div class="info-row" style="background: rgba(76, 175, 80, 0.2);">
          <span class="info-label">Total Cost</span>
          <span class="info-value" id="total-cost" style="font-size: 18px;">‡ß≥55.00</span>
        </div>

        <div class="info-row">
          <span class="info-label">Worker Will Get</span>
          <span class="info-value" id="worker-pay">‡ß≥0.050 per task</span>
        </div>

        <div class="info-row">
          <span class="info-label">Your Active Jobs</span>
          <span class="info-value" id="active-jobs-count">0/1</span>
        </div>

        <button class="btn" onclick="submitJobPost()" id="post-job-btn">
          <i class="fas fa-cloud-upload-alt"></i> Submit Job for Approval
        </button>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-info-circle"></i>
          <h3>Pricing Guide</h3>
        </div>
        <div class="info-row">
          <span>1,000 Tasks</span>
          <span>Base ‡ß≥50 + 10% = ‡ß≥55</span>
        </div>
        <div class="info-row">
          <span>2,000 Tasks</span>
          <span>Base ‡ß≥100 + 10% = ‡ß≥110</span>
        </div>
        <div class="info-row">
          <span>3,000 Tasks</span>
          <span>Base ‡ß≥150 + 10% = ‡ß≥165</span>
        </div>
        <div class="info-row">
          <span>5,000 Tasks</span>
          <span>Base ‡ß≥250 + 10% = ‡ß≥275</span>
        </div>
        <div class="info-row">
          <span>7,000 Tasks</span>
          <span>Base ‡ß≥350 + 10% = ‡ß≥385</span>
        </div>
        <div class="info-row">
          <span>10,000 Tasks</span>
          <span>Base ‡ß≥500 + 10% = ‡ß≥550</span>
        </div>
        <p style="font-size: 12px; opacity: 0.8; margin-top: 10px;">
          * ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶∞‡ßá‡¶ü ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá
        </p>
      </div>
    </div>

    <!-- My Jobs Section -->
    <div id="my-jobs" class="cards-container" style="display: none;">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-briefcase"></i>
          <h3>My Posted Jobs</h3>
        </div>
        <div id="my-jobs-list"></div>
      </div>

      <!-- Update Job Modal (Hidden by default) -->
      <div id="update-job-modal" style="display: none;">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-sync-alt"></i>
            <h3>Update Job</h3>
          </div>
          <input type="hidden" id="update-job-id">
          
          <div class="input-group">
            <label class="input-label">Number of Tasks</label>
            <select id="update-tasks">
              <option value="1000">1,000 Tasks</option>
              <option value="2000">2,000 Tasks</option>
              <option value="3000">3,000 Tasks</option>
              <option value="5000">5,000 Tasks</option>
              <option value="7000">7,000 Tasks</option>
              <option value="10000">10,000 Tasks</option>
            </select>
          </div>

          <div class="input-group">
            <label class="input-label">Pay per Task (Minimum ‡ß≥0.050)</label>
            <input type="number" id="update-rate" value="0.050" min="0.050" step="0.001">
          </div>

          <div class="info-row">
            <span class="info-label">Subtotal</span>
            <span class="info-value" id="update-subtotal">‡ß≥0.00</span>
          </div>
          <div class="info-row">
            <span class="info-label">Service Charge (+10%)</span>
            <span class="info-value" id="update-service">‡ß≥0.00</span>
          </div>
          <div class="info-row" style="background: rgba(76, 175, 80, 0.2);">
            <span class="info-label">Total Cost</span>
            <span class="info-value" id="update-total">‡ß≥0.00</span>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="cancelUpdate()">Cancel</button>
            <button class="btn" onclick="confirmUpdate()">Confirm Update</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Withdraw Section (only withdrawal history) -->
    <div id="withdraw" class="cards-container" style="display: none;">
      <!-- Timing Notice -->
      <div class="notice-card">
        <i class="fas fa-clock"></i>
        <p><strong>‚è∞ Withdrawal Time:</strong> ‡¶∏‡¶ï‡¶æ‡¶≤ 10 ‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶§ 10 ‡¶ü‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶Ü‡¶™‡¶®‡¶ø withdraw ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-money-bill-wave"></i>
          <h3>Withdraw Funds</h3>
        </div>
        
        <div class="info-row">
          <span class="info-label">Available Balance</span>
          <span class="info-value">‡ß≥<span id="available-balance">0.00</span></span>
        </div>
        <div class="info-row">
          <span class="info-label">Total Withdrawn</span>
          <span class="info-value">‡ß≥<span id="total-withdrawn">0.00</span></span>
        </div>
        <div class="info-row">
          <span class="info-label">Minimum Withdrawal</span>
          <span class="info-value">‡ß≥1500.00</span>
        </div>
        <div class="info-row">
          <span class="info-label">Referrals Needed</span>
          <span class="info-value"><span id="withdraw-referrals">0</span>/10</span>
        </div>

        <div class="input-group">
          <label class="input-label">Enter Amount (BDT)</label>
          <input type="number" id="withdraw-amount" placeholder="Enter amount" min="1500" step="1" oninput="calculatePayout()">
        </div>

        <div class="info-row" style="background: rgba(255, 215, 0, 0.2);">
          <span class="info-label">Commission (-10%)</span>
          <span class="info-value" id="commission-amount">‡ß≥0.00</span>
        </div>
        <div class="info-row" style="background: rgba(76, 175, 80, 0.2);">
          <span class="info-label">You Will Receive</span>
          <span class="info-value" id="payout-amount">‡ß≥0.00</span>
        </div>

        <div class="input-group">
          <label class="input-label">Payment Method</label>
          <select id="withdraw-method">
            <option value="">Select a method</option>
            <option value="Bkash">Bkash</option>
            <option value="Nagad">Nagad</option>
            <option value="Rocket">Rocket</option>
          </select>
        </div>

        <div class="input-group">
          <label class="input-label">Payment Address</label>
          <input type="text" id="withdraw-address" placeholder="Enter payment address">
        </div>

        <button class="btn btn-navy" onclick="submitWithdrawal()">
          <i class="fas fa-paper-plane"></i> Submit Withdrawal
        </button>
      </div>

      <!-- Withdrawal History (only) -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-history"></i>
          <h3>Withdrawal History (Last 5)</h3>
        </div>
        <div id="withdrawal-history" class="history-list"></div>
      </div>
    </div>

    <!-- Deposit Section (with deposit history and notice) -->
    <div id="deposit" class="cards-container" style="display: none;">
      <!-- Timing Notice -->
      <div class="notice-card">
        <i class="fas fa-clock"></i>
        <p><strong>‚è∞ Deposit Time:</strong> ‡¶∏‡¶ï‡¶æ‡¶≤ 10 ‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶§ 10 ‡¶ü‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶Ü‡¶™‡¶®‡¶ø deposit ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®‡•§</p>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-credit-card"></i>
          <h3>Deposit Funds</h3>
        </div>

        <div class="info-row">
          <span class="info-label">Bkash (Personal)</span>
          <span class="info-value">017XXXXXXXX</span>
        </div>
        <div class="info-row">
          <span class="info-label">Nagad (Personal)</span>
          <span class="info-value">018XXXXXXXX</span>
        </div>
        <div class="info-row">
          <span class="info-label">Rocket (Personal)</span>
          <span class="info-value">019XXXXXXXX</span>
        </div>

        <div class="input-group">
          <label class="input-label">Amount (BDT)</label>
          <input type="number" id="deposit-amount" placeholder="Enter amount" min="100" step="1">
        </div>

        <div class="input-group">
          <label class="input-label">Payment Method</label>
          <select id="deposit-method">
            <option value="">Select a method</option>
            <option value="Bkash">Bkash</option>
            <option value="Nagad">Nagad</option>
            <option value="Rocket">Rocket</option>
          </select>
        </div>

        <div class="input-group">
          <label class="input-label">Transaction ID</label>
          <input type="text" id="deposit-trx" placeholder="Enter transaction ID">
        </div>

        <button class="btn btn-secondary" onclick="submitDeposit()">
          <i class="fas fa-paper-plane"></i> Submit Deposit
        </button>
      </div>

      <!-- Deposit History (moved from withdraw) -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-history"></i>
          <h3>Deposit History (Last 5)</h3>
        </div>
        <div id="deposit-history" class="history-list"></div>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profile-page" class="cards-container" style="display: none;">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-user"></i>
          <h3>Profile Information</h3>
        </div>
        <div class="profile-header">
          <div class="profile-img-container">
            <img id="profile-page-img" src="https://via.placeholder.com/80" alt="Profile">
          </div>
          <div class="profile-info">
            <div class="name" id="profile-name">Loading...</div>
            <div class="user-id">ID: <span id="profile-user-id">------</span></div>
          </div>
        </div>
        <div class="info-row">
          <span class="info-label">Username</span>
          <span class="info-value" id="profile-username">@username</span>
        </div>
        <div class="info-row">
          <span class="info-label">Member Since</span>
          <span class="info-value" id="member-since">Just now</span>
        </div>
      </div>

      <!-- Referral Program -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-users"></i>
          <h3>Referral Program</h3>
        </div>
        
        <div class="referral-link-container">
          <div class="referral-link" id="referral-link">Loading...</div>
          <button class="btn btn-secondary" onclick="copyReferralLink()">
            <i class="fas fa-copy"></i> Copy Link
          </button>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="total-referrals">0</div>
            <div class="stat-label">Total Referrals</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">‡ß≥<span id="referral-earnings">0.00</span></div>
            <div class="stat-label">Commission Earned</div>
          </div>
        </div>

        <!-- Referral History -->
        <div class="history-header" style="margin-top: 20px;">
          <i class="fas fa-history"></i> Referral History (Last 5)
        </div>
        <div id="referral-history" class="history-list"></div>
      </div>

      <!-- Transaction History -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-exchange-alt"></i>
          <h3>Transaction History (Last 10)</h3>
        </div>
        <div id="transaction-history" class="history-list"></div>
      </div>

      <!-- Admin Access -->
      <div id="admin-access" style="display: none;">
        <button class="btn btn-purple" onclick="toggleAdminPanel()">
          <i class="fas fa-cog"></i> Admin Panel
        </button>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <div class="nav-item active" id="nav-home" onclick="show('home')">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" id="nav-earn" onclick="show('earn')">
        <i class="fas fa-coins"></i>
        <span>Earn</span>
      </div>
      <div class="nav-item" id="nav-post" onclick="show('post-job')">
        <i class="fas fa-plus-circle"></i>
        <span>Post</span>
      </div>
      <div class="nav-item" id="nav-myjobs" onclick="show('my-jobs')">
        <i class="fas fa-briefcase"></i>
        <span>My Jobs</span>
      </div>
      <div class="nav-item" id="nav-profile" onclick="show('profile')">
        <i class="fas fa-user"></i>
        <span>Profile</span>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const BOT_TOKEN = "8776517486:AAEofGA5QJ-XNfx37yMz4rc6RFk_l_Y9Wh0";
    const ADMIN_CHAT_ID = "6892959740";
    const MIN_RATE = 0.050;
    const COMMISSION_PERCENT = 10; // 10% commission on withdraw
    const REFERRAL_COMMISSION = 5; // 5% commission on referred user's withdrawal
    const JOB_RENEWAL_COST = 100; // 100 BDT every 30 days
    const JOB_RENEWAL_DAYS = 30;
    
    // Task counts
    const TASK_OPTIONS = [1000, 2000, 3000, 5000, 7000, 10000];

    // ==================== GLOBAL VARIABLES ====================
    let userData = null;
    let jobs = [];
    let withdrawRequests = [];
    let depositRequests = [];
    let nextJobId = 101; // Starting job ID

    // ==================== INITIALIZATION ====================
    let tg = window.Telegram?.WebApp;
    
    if (tg) {
      tg.ready();
      tg.expand();
    }

    window.addEventListener('DOMContentLoaded', function() {
      initializeUser();
      loadJobs();
      loadRequests();
      loadNextJobId();
      updateDisplay();
      setupEventListeners();
      checkAdminAccess();
      checkJobExpirations();
    });

    function initializeUser() {
      let user = null;
      
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        user = tg.initDataUnsafe.user;
      } else {
        user = {
          id: 123456789,
          first_name: "Demo",
          last_name: "User",
          username: "demouser",
          photo_url: "https://via.placeholder.com/80"
        };
      }

      const storageKey = `userData_${user.id}`;
      const savedData = localStorage.getItem(storageKey);

      if (savedData) {
        userData = JSON.parse(savedData);
      } else {
        userData = {
          userId: user.id,
          firstName: user.first_name,
          lastName: user.last_name || '',
          username: user.username || '',
          photoUrl: user.photo_url || 'https://via.placeholder.com/80',
          balance: 0,
          lifetimeEarning: 0,
          withdrew: 0,
          deposited: 0,
          totalTasks: 0,
          referrals: 0,
          referralEarnings: 0,
          referredBy: null,
          joinDate: new Date().toISOString(),
          transactions: [],
          dailyTasks: {}, // { date: [jobIds] } to track daily completions
          isAdmin: false,
          jobPostCount: 0,
          jobExpiry: {} // { jobId: expiryDate }
        };

        // Check if this user was referred
        const urlParams = new URLSearchParams(window.location.search);
        const startParam = urlParams.get('tgWebAppStartParam') || '';
        const referrerId = startParam.replace('ref_', '');
        if (referrerId && referrerId !== '' && referrerId != user.id) {
          userData.referredBy = referrerId;
          // Add referral to referrer
          addReferral(referrerId, user.id);
        }

        localStorage.setItem(storageKey, JSON.stringify(userData));
      }
    }

    function addReferral(referrerId, newUserId) {
      const referrerKey = `userData_${referrerId}`;
      const referrerData = localStorage.getItem(referrerKey);
      if (referrerData) {
        const referrer = JSON.parse(referrerData);
        referrer.referrals = (referrer.referrals || 0) + 1;
        localStorage.setItem(referrerKey, JSON.stringify(referrer));
      }
    }

    function loadNextJobId() {
      const lastId = localStorage.getItem('lastJobId');
      if (lastId) {
        nextJobId = parseInt(lastId) + 1;
      } else {
        // Find max job id from existing jobs
        let maxId = 100;
        jobs.forEach(j => {
          if (j.displayId && j.displayId > maxId) maxId = j.displayId;
        });
        nextJobId = maxId + 1;
      }
    }

    function saveLastJobId() {
      localStorage.setItem('lastJobId', nextJobId);
    }

    // ==================== JOB FUNCTIONS ====================
    function loadJobs() {
      jobs = JSON.parse(localStorage.getItem('jobs')) || [];
    }

    function saveJobs() {
      localStorage.setItem('jobs', JSON.stringify(jobs));
    }

    function calculateJobCost(tasks, rate) {
      const subtotal = tasks * rate;
      const serviceCharge = subtotal * 0.10; // 10% service charge
      const total = subtotal + serviceCharge;
      return { subtotal, serviceCharge, total };
    }

    // Update pricing on job post form
    function setupEventListeners() {
      const tasksSelect = document.getElementById('job-tasks');
      const rateInput = document.getElementById('job-rate');
      const updateTasks = document.getElementById('update-tasks');
      const updateRate = document.getElementById('update-rate');

      if (tasksSelect) {
        tasksSelect.addEventListener('change', updatePricing);
      }
      if (rateInput) {
        rateInput.addEventListener('input', updatePricing);
      }
      if (updateTasks) {
        updateTasks.addEventListener('change', updateUpdatePricing);
      }
      if (updateRate) {
        updateRate.addEventListener('input', updateUpdatePricing);
      }

      const withdrawAmount = document.getElementById('withdraw-amount');
      if (withdrawAmount) {
        withdrawAmount.addEventListener('input', calculatePayout);
      }
    }

    function updatePricing() {
      const tasks = parseInt(document.getElementById('job-tasks').value);
      const rate = parseFloat(document.getElementById('job-rate').value) || MIN_RATE;
      
      const cost = calculateJobCost(tasks, rate);
      
      document.getElementById('subtotal').textContent = `‡ß≥${cost.subtotal.toFixed(2)}`;
      document.getElementById('service-charge').textContent = `‡ß≥${cost.serviceCharge.toFixed(2)}`;
      document.getElementById('total-cost').textContent = `‡ß≥${cost.total.toFixed(2)}`;
      document.getElementById('worker-pay').textContent = `‡ß≥${rate.toFixed(3)} per task`;
    }

    function updateUpdatePricing() {
      const tasks = parseInt(document.getElementById('update-tasks').value);
      const rate = parseFloat(document.getElementById('update-rate').value) || MIN_RATE;
      
      const cost = calculateJobCost(tasks, rate);
      
      document.getElementById('update-subtotal').textContent = `‡ß≥${cost.subtotal.toFixed(2)}`;
      document.getElementById('update-service').textContent = `‡ß≥${cost.serviceCharge.toFixed(2)}`;
      document.getElementById('update-total').textContent = `‡ß≥${cost.total.toFixed(2)}`;
    }

    // Submit job post
    function submitJobPost() {
      const adsteraLink = document.getElementById('job-adstera-link').value;
      const tasks = parseInt(document.getElementById('job-tasks').value);
      const rate = parseFloat(document.getElementById('job-rate').value);
      
      if (!adsteraLink) {
        showNotification("Please enter your Adstera smart link", "error");
        return;
      }

      if (rate < MIN_RATE) {
        showNotification(`Minimum rate is ‡ß≥${MIN_RATE.toFixed(3)} per task`, "error");
        return;
      }

      // Check if user already has an active job
      const activeJobs = jobs.filter(j => j.posterId === userData.userId && j.status === 'active');
      if (activeJobs.length >= 1) {
        showNotification("You can only post one active job at a time", "error");
        return;
      }

      const cost = calculateJobCost(tasks, rate);
      
      if (userData.balance < cost.total) {
        showNotification("Insufficient balance! Please deposit first.", "error");
        show('deposit');
        return;
      }

      // Create job with display ID
      const jobId = 'JOB' + Date.now();
      const displayId = nextJobId++;

      const job = {
        id: jobId,
        displayId: displayId,
        posterId: userData.userId,
        posterName: userData.firstName + ' ' + userData.lastName,
        adsteraLink: adsteraLink,
        totalTasks: tasks,
        completedTasks: 0,
        ratePerTask: rate,
        totalCost: cost.total,
        status: 'pending',
        workers: [], // array of { userId, date }
        createdAt: new Date().toISOString(),
        lastRenewed: new Date().toISOString(),
        expired: false,
        priority: rate
      };

      // Deduct balance
      userData.balance -= cost.total;
      userData.transactions.push({
        id: 'JOB' + Date.now(),
        type: 'job_post',
        amount: -cost.total,
        status: 'completed',
        date: new Date().toISOString(),
        jobId: job.id
      });

      jobs.push(job);
      saveJobs();
      saveLastJobId();
      updateStorage();
      updateDisplay();
      
      showNotification("Job posted successfully! Waiting for admin approval.", "success");
      
      // Send notification to admin
      sendJobToAdmin(job);

      // Clear form
      document.getElementById('job-adstera-link').value = '';
      document.getElementById('job-rate').value = MIN_RATE.toFixed(3);
      updatePricing();
      
      show('my-jobs');
    }

    // Send job to admin for approval
    function sendJobToAdmin(job) {
      const message = `
üìã <b>NEW JOB PENDING APPROVAL</b>

üÜî <b>Job ID:</b> #${job.displayId}
üë§ <b>Poster:</b> ${job.posterName} (ID: ${job.posterId})
üìä <b>Tasks:</b> ${job.totalTasks.toLocaleString()}
üí∞ <b>Rate:</b> ‡ß≥${job.ratePerTask.toFixed(3)} per task
üíµ <b>Total Cost:</b> ‡ß≥${job.totalCost.toFixed(2)}
üîó <b>Adstera Link:</b> ${job.adsteraLink}

Please check and approve.
      `;

      const buttons = [[
        { text: '‚úÖ Approve', callback_data: `approve_job_${job.id}` },
        { text: '‚ùå Reject', callback_data: `reject_job_${job.id}` }
      ]];

      sendTelegramMessage(ADMIN_CHAT_ID, message, buttons);
    }

    // Admin approve job
    function approveJob(jobId, newLink) {
      const job = jobs.find(j => j.id === jobId);
      if (job) {
        if (newLink) job.adsteraLink = newLink;
        job.status = 'active';
        // Set expiry date (30 days from now)
        job.expiryDate = new Date(Date.now() + JOB_RENEWAL_DAYS * 24 * 60 * 60 * 1000).toISOString();
        saveJobs();
        showNotification("Job approved and published!", "success");
        
        // Notify job poster
        sendTelegramMessage(job.posterId, `
‚úÖ <b>Your Job #${job.displayId} Has Been Approved!</b>

Your job with ${job.totalTasks.toLocaleString()} tasks at ‡ß≥${job.ratePerTask.toFixed(3)} per task is now live.

Check "My Jobs" section to track progress.
        `);
      }
    }

    // Display available jobs in Earn section
    function displayAvailableJobs() {
      const container = document.getElementById('available-jobs-list');
      const today = new Date().toLocaleDateString();
      
      // Get active jobs
      let activeJobs = jobs.filter(j => j.status === 'active' && !j.expired && j.completedTasks < j.totalTasks);
      
      // Filter out jobs that the user has already completed today
      const userTodayTasks = userData.dailyTasks?.[today] || [];
      activeJobs = activeJobs.filter(job => !userTodayTasks.includes(job.id));
      
      if (activeJobs.length === 0) {
        container.innerHTML = '<div class="empty-history">No jobs available</div>';
        return;
      }

      // Sort by priority (higher rate first)
      activeJobs.sort((a, b) => b.ratePerTask - a.ratePerTask);

      container.innerHTML = '';
      activeJobs.forEach(job => {
        const jobDiv = document.createElement('div');
        jobDiv.className = 'job-item';
        
        const remaining = job.totalTasks - job.completedTasks;
        const progress = (job.completedTasks / job.totalTasks * 100).toFixed(1);
        const isHighRate = job.ratePerTask > MIN_RATE + 0.005;

        jobDiv.innerHTML = `
          <div class="job-header">
            <div>
              <span class="job-id">#${job.displayId}</span>
              <span class="timer-badge"><i class="fas fa-hourglass-half"></i> 15s</span>
            </div>
            <div class="job-price ${isHighRate ? 'high' : ''}">
              ‡ß≥${job.ratePerTask.toFixed(3)}
            </div>
          </div>
          
          <div class="job-user">
            <i class="fas fa-user-circle"></i>
            <span>Posted by ${job.posterName}</span>
          </div>
          
          <div class="progress-info">
            <span>Completed: ${job.completedTasks}/${job.totalTasks}</span>
            <span>Remaining: ${remaining}</span>
          </div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${progress}%;"></div>
          </div>

          <div class="job-footer">
            <button class="btn" onclick="viewAd('${job.id}')">
              <i class="fas fa-play"></i> View Ad
            </button>
            <button class="btn btn-secondary" onclick="shareJob('${job.displayId}')">
              <i class="fas fa-share-alt"></i>
            </button>
          </div>
        `;

        container.appendChild(jobDiv);
      });
    }

    // View Ad and complete task
    function viewAd(jobId) {
      const job = jobs.find(j => j.id === jobId);
      
      if (!job || job.status !== 'active' || job.expired) {
        showNotification("Job not available", "error");
        return;
      }

      if (job.completedTasks >= job.totalTasks) {
        showNotification("This job has been completed", "warning");
        return;
      }

      const today = new Date().toLocaleDateString();
      const userTodayTasks = userData.dailyTasks?.[today] || [];
      
      if (userTodayTasks.includes(jobId)) {
        showNotification("You have already completed a task from this job today. Come back tomorrow!", "warning");
        return;
      }

      const adLink = job.adsteraLink; // Use the same link for all tasks (could be randomized)
      const start = Date.now();
      const ad = window.open(adLink, "_blank");

      if (!ad) {
        showNotification("Please allow popups to view ads", "error");
        return;
      }

      // Show timer
      const timerDiv = document.createElement('div');
      timerDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 30px;
        border-radius: 20px;
        z-index: 1001;
        text-align: center;
        border: 2px solid #4CAF50;
      `;
      timerDiv.innerHTML = `
        <i class="fas fa-hourglass-half" style="font-size: 48px; color: #4CAF50; margin-bottom: 15px;"></i>
        <div style="font-size: 36px; font-weight: bold;" id="timer">15</div>
        <div style="margin-top: 10px;">Seconds remaining</div>
        <div style="font-size: 12px; margin-top: 15px; opacity: 0.7;">Please wait in the ad</div>
      `;
      document.body.appendChild(timerDiv);

      let seconds = 15;
      const timer = setInterval(() => {
        seconds--;
        document.getElementById('timer').textContent = seconds;
        
        if (seconds <= 0) {
          clearInterval(timer);
          timerDiv.remove();
          
          if (!ad.closed) {
            ad.close();
          }

          // Complete task
          job.completedTasks++;
          job.workers.push({
            userId: userData.userId,
            date: new Date().toISOString()
          });

          // Update daily tasks
          if (!userData.dailyTasks) userData.dailyTasks = {};
          if (!userData.dailyTasks[today]) userData.dailyTasks[today] = [];
          userData.dailyTasks[today].push(jobId);

          // Add earnings
          userData.balance += job.ratePerTask;
          userData.lifetimeEarning += job.ratePerTask;
          userData.totalTasks++;

          // Add transaction
          userData.transactions.push({
            id: 'EARN' + Date.now(),
            type: 'task_complete',
            amount: job.ratePerTask,
            status: 'completed',
            date: new Date().toISOString(),
            jobId: job.id
          });

          // Check if job is completed
          if (job.completedTasks >= job.totalTasks) {
            job.status = 'completed';
            
            // Notify job poster
            sendTelegramMessage(job.posterId, `
‚úÖ <b>Your Job #${job.displayId} Has Been Completed!</b>

All ${job.totalTasks.toLocaleString()} tasks have been completed.
Total paid: ‡ß≥${(job.totalTasks * job.ratePerTask).toFixed(2)}
            `);
          }

          saveJobs();
          updateStorage();
          updateDisplay();
          displayAvailableJobs();
          
          showNotification(`‚úÖ Task completed! ‡ß≥${job.ratePerTask.toFixed(3)} added to your balance.`, "success");
        }
      }, 1000);

      // Check if ad closed early
      const adCheck = setInterval(() => {
        if (ad.closed && seconds > 0) {
          clearInterval(timer);
          clearInterval(adCheck);
          timerDiv.remove();
          showNotification("You closed the ad too early! Please wait 15 seconds.", "error");
        }
      }, 500);
    }

    // Display user's posted jobs
    function displayMyJobs() {
      const container = document.getElementById('my-jobs-list');
      const userJobs = jobs.filter(j => j.posterId === userData.userId);
      
      if (userJobs.length === 0) {
        container.innerHTML = '<div class="empty-history">You haven\'t posted any jobs yet</div>';
        return;
      }

      // Sort by date (newest first)
      userJobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      container.innerHTML = '';
      userJobs.forEach(job => {
        const jobDiv = document.createElement('div');
        jobDiv.className = 'job-item';
        
        const remaining = job.totalTasks - job.completedTasks;
        const progress = (job.completedTasks / job.totalTasks * 100).toFixed(1);
        const isExpired = job.expired || (job.expiryDate && new Date(job.expiryDate) < new Date());
        const status = isExpired ? 'expired' : job.status;

        let actionButton = '';
        if (job.status === 'completed' || isExpired) {
          actionButton = `<button class="btn btn-warning" onclick="showUpdateJob('${job.id}')">Update Job</button>`;
        }

        jobDiv.innerHTML = `
          <div class="job-header">
            <div>
              <span class="job-id">#${job.displayId}</span>
              <span class="status-badge status-${status}">${status}</span>
            </div>
            <div class="job-price">
              ‡ß≥${job.ratePerTask.toFixed(3)}
            </div>
          </div>
          
          <div class="progress-info">
            <span>Completed: ${job.completedTasks}/${job.totalTasks}</span>
            <span>Remaining: ${remaining}</span>
          </div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${progress}%;"></div>
          </div>

          <div class="info-row">
            <span>Total Cost</span>
            <span>‡ß≥${job.totalCost.toFixed(2)}</span>
          </div>
          <div class="info-row">
            <span>Posted</span>
            <span>${new Date(job.createdAt).toLocaleDateString()}</span>
          </div>
          ${actionButton}
        `;

        container.appendChild(jobDiv);
      });
    }

    // Show update job modal
    function showUpdateJob(jobId) {
      const job = jobs.find(j => j.id === jobId);
      if (!job) return;
      
      document.getElementById('update-job-id').value = jobId;
      document.getElementById('update-tasks').value = '1000'; // default
      document.getElementById('update-rate').value = job.ratePerTask.toFixed(3);
      document.getElementById('update-job-modal').style.display = 'block';
      updateUpdatePricing();
    }

    function cancelUpdate() {
      document.getElementById('update-job-modal').style.display = 'none';
    }

    function confirmUpdate() {
      const jobId = document.getElementById('update-job-id').value;
      const tasks = parseInt(document.getElementById('update-tasks').value);
      const rate = parseFloat(document.getElementById('update-rate').value);
      
      const cost = calculateJobCost(tasks, rate);
      
      if (userData.balance < cost.total) {
        showNotification("Insufficient balance! Please deposit first.", "error");
        show('deposit');
        return;
      }

      const job = jobs.find(j => j.id === jobId);
      if (job) {
        // Deduct balance
        userData.balance -= cost.total;
        userData.transactions.push({
          id: 'UPD' + Date.now(),
          type: 'job_update',
          amount: -cost.total,
          status: 'completed',
          date: new Date().toISOString(),
          jobId: job.id
        });

        // Update job
        job.totalTasks += tasks;
        job.ratePerTask = rate;
        job.totalCost += cost.total;
        job.status = 'pending'; // Need admin approval again? Or auto-active? We'll set pending.
        job.expired = false;
        job.expiryDate = new Date(Date.now() + JOB_RENEWAL_DAYS * 24 * 60 * 60 * 1000).toISOString();
        
        saveJobs();
        updateStorage();
        updateDisplay();
        cancelUpdate();
        showNotification("Job updated and sent for approval!", "success");
        
        // Notify admin
        sendJobToAdmin(job);
      }
    }

    // Check job expirations
    function checkJobExpirations() {
      const now = new Date();
      jobs.forEach(job => {
        if (job.status === 'active' && job.expiryDate && new Date(job.expiryDate) < now) {
          job.expired = true;
          job.status = 'expired';
        }
      });
      saveJobs();
    }

    // ==================== WITHDRAW FUNCTIONS ====================
    function calculatePayout() {
      const amount = parseFloat(document.getElementById('withdraw-amount').value) || 0;
      const commission = amount * (COMMISSION_PERCENT / 100);
      const payout = amount - commission;
      document.getElementById('commission-amount').textContent = `‡ß≥${commission.toFixed(2)}`;
      document.getElementById('payout-amount').textContent = `‡ß≥${payout.toFixed(2)}`;
    }

    function submitWithdrawal() {
      const amount = parseFloat(document.getElementById('withdraw-amount').value);
      const method = document.getElementById('withdraw-method').value;
      const address = document.getElementById('withdraw-address').value;
      
      if (isNaN(amount) || amount < 1500) {
        showNotification("Minimum withdrawal amount is ‡ß≥1500", "error");
        return;
      }
      if (amount > userData.balance) {
        showNotification("Insufficient balance", "error");
        return;
      }
      if ((userData.referrals || 0) < 0) {
        showNotification("You need at least 10 referrals to withdraw", "error");
        return;
      }
      if (!method) {
        showNotification("Please select a withdrawal method", "error");
        return;
      }
      if (!address) {
        showNotification("Please enter your payment address", "error");
        return;
      }

      const commission = amount * (COMMISSION_PERCENT / 100);
      const payout = amount - commission;

      const request = {
        id: 'W' + Date.now(),
        userId: userData.userId,
        userName: userData.firstName + ' ' + userData.lastName,
        amount: amount,
        commission: commission,
        payout: payout,
        method: method,
        address: address,
        date: new Date().toISOString(),
        status: 'pending'
      };

      withdrawRequests.push(request);
      saveRequests();

      // Update balance (deduct full amount)
      userData.balance -= amount;
      userData.withdrew += amount;
      userData.transactions.push({
        id: request.id,
        type: 'withdraw',
        amount: -amount,
        status: 'pending',
        date: new Date().toISOString(),
        commission: commission
      });

      updateStorage();
      updateDisplay();
      showNotification("Withdrawal request submitted!", "success");

      // Notify admin
      sendTelegramMessage(ADMIN_CHAT_ID, `
üí∏ <b>NEW WITHDRAWAL REQUEST</b>

üë§ User: ${request.userName} (ID: ${userData.userId})
üí∞ Amount: ‡ß≥${amount.toFixed(2)}
üí≥ Method: ${method}
üìß Address: ${address}
üíµ Payout: ‡ß≥${payout.toFixed(2)} (${COMMISSION_PERCENT}% commission)

üÜî Request ID: <code>${request.id}</code>
      `);

      // Clear form
      document.getElementById('withdraw-amount').value = '';
      document.getElementById('withdraw-method').value = '';
      document.getElementById('withdraw-address').value = '';
      calculatePayout();
    }

    // Approve withdraw (admin)
    function approveWithdraw(requestId) {
      const req = withdrawRequests.find(r => r.id === requestId);
      if (req && req.status === 'pending') {
        req.status = 'approved';
        
        // Add commission to admin? Not needed.
        // Update user transaction
        const userKey = `userData_${req.userId}`;
        const user = JSON.parse(localStorage.getItem(userKey));
        if (user) {
          const transaction = user.transactions.find(t => t.id === requestId);
          if (transaction) transaction.status = 'completed';
          localStorage.setItem(userKey, JSON.stringify(user));
        }

        saveRequests();
        showNotification("Withdraw approved!", "success");
        
        // Notify user
        sendTelegramMessage(req.userId, `
‚úÖ <b>Withdrawal Approved!</b>

Your withdrawal of ‡ß≥${req.amount.toFixed(2)} has been approved.
You will receive ‡ß≥${req.payout.toFixed(2)} (after ${COMMISSION_PERCENT}% commission) to your ${req.method} account shortly.
        `);
      }
    }

    function rejectWithdraw(requestId) {
      const req = withdrawRequests.find(r => r.id === requestId);
      if (req && req.status === 'pending') {
        req.status = 'rejected';
        
        // Refund user
        const userKey = `userData_${req.userId}`;
        const user = JSON.parse(localStorage.getItem(userKey));
        if (user) {
          user.balance += req.amount;
          user.withdrew -= req.amount;
          const transaction = user.transactions.find(t => t.id === requestId);
          if (transaction) transaction.status = 'rejected';
          localStorage.setItem(userKey, JSON.stringify(user));
        }

        saveRequests();
        showNotification("Withdraw rejected and refunded", "warning");
        
        sendTelegramMessage(req.userId, `
‚ùå <b>Withdrawal Rejected</b>

Your withdrawal request of ‡ß≥${req.amount.toFixed(2)} has been rejected. The amount has been refunded to your balance.
        `);
      }
    }

    // ==================== DEPOSIT FUNCTIONS ====================
    function submitDeposit() {
      const amount = parseFloat(document.getElementById('deposit-amount').value);
      const method = document.getElementById('deposit-method').value;
      const trxId = document.getElementById('deposit-trx').value;

      if (isNaN(amount) || amount < 100) {
        showNotification("Minimum deposit amount is ‡ß≥100", "error");
        return;
      }
      if (!method) {
        showNotification("Please select a payment method", "error");
        return;
      }
      if (!trxId) {
        showNotification("Please enter transaction ID", "error");
        return;
      }

      const request = {
        id: 'D' + Date.now(),
        userId: userData.userId,
        userName: userData.firstName + ' ' + userData.lastName,
        amount: amount,
        method: method,
        trxId: trxId,
        date: new Date().toISOString(),
        status: 'pending'
      };

      depositRequests.push(request);
      saveRequests();

      showNotification("Deposit request submitted! Waiting for admin approval.", "success");

      sendTelegramMessage(ADMIN_CHAT_ID, `
üí≥ <b>NEW DEPOSIT REQUEST</b>

üë§ User: ${request.userName} (ID: ${userData.userId})
üí∞ Amount: ‡ß≥${amount.toFixed(2)}
üí≥ Method: ${method}
üî¢ TRX ID: ${trxId}

üÜî Request ID: <code>${request.id}</code>
      `);

      // Clear form
      document.getElementById('deposit-amount').value = '';
      document.getElementById('deposit-method').value = '';
      document.getElementById('deposit-trx').value = '';
    }

    function approveDeposit(requestId) {
      const req = depositRequests.find(r => r.id === requestId);
      if (req && req.status === 'pending') {
        req.status = 'approved';
        
        // Add to user balance
        const userKey = `userData_${req.userId}`;
        const user = JSON.parse(localStorage.getItem(userKey));
        if (user) {
          user.balance += req.amount;
          user.deposited += req.amount;
          user.transactions.push({
            id: req.id,
            type: 'deposit',
            amount: req.amount,
            status: 'completed',
            date: new Date().toISOString()
          });
          localStorage.setItem(userKey, JSON.stringify(user));
        }

        saveRequests();
        showNotification("Deposit approved!", "success");
        
        sendTelegramMessage(req.userId, `
‚úÖ <b>Deposit Approved!</b>

Your deposit of ‡ß≥${req.amount.toFixed(2)} via ${req.method} has been approved and added to your balance.
        `);
      }
    }

    function rejectDeposit(requestId) {
      const req = depositRequests.find(r => r.id === requestId);
      if (req && req.status === 'pending') {
        req.status = 'rejected';
        saveRequests();
        showNotification("Deposit rejected", "warning");
        
        sendTelegramMessage(req.userId, `
‚ùå <b>Deposit Rejected</b>

Your deposit request of ‡ß≥${req.amount.toFixed(2)} has been rejected. Please check your transaction ID and try again.
        `);
      }
    }

    // ==================== REFERRAL FUNCTIONS ====================
    // When a referred user withdraws, give 5% commission to referrer
    function addReferralCommission(referredUserId, withdrawAmount) {
      const referredUserKey = `userData_${referredUserId}`;
      const referredUser = JSON.parse(localStorage.getItem(referredUserKey));
      if (referredUser && referredUser.referredBy) {
        const referrerKey = `userData_${referredUser.referredBy}`;
        const referrer = JSON.parse(localStorage.getItem(referrerKey));
        if (referrer) {
          const commission = withdrawAmount * (REFERRAL_COMMISSION / 100);
          referrer.balance += commission;
          referrer.referralEarnings = (referrer.referralEarnings || 0) + commission;
          referrer.transactions.push({
            id: 'REF' + Date.now(),
            type: 'referral_commission',
            amount: commission,
            status: 'completed',
            date: new Date().toISOString(),
            from: referredUserId
          });
          localStorage.setItem(referrerKey, JSON.stringify(referrer));
          
          sendTelegramMessage(referrer.userId, `
üí∞ <b>Referral Commission!</b>

You earned ‡ß≥${commission.toFixed(2)} (5%) from your referred user's withdrawal of ‡ß≥${withdrawAmount.toFixed(2)}.
          `);
        }
      }
    }

    // ==================== ADMIN FUNCTIONS ====================
    function checkAdminAccess() {
      const adminUsers = [6892959740, 6892959740]; // Add your admin IDs
      
      if (userData && adminUsers.includes(userData.userId)) {
        userData.isAdmin = true;
        document.getElementById('admin-access').style.display = 'block';
        updateStorage();
      }
    }

    function toggleAdminPanel() {
      const panel = document.getElementById('admin-panel');
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
      } else {
        panel.style.display = 'block';
        loadAdminPanel();
      }
    }

    function loadAdminPanel() {
      // Pending jobs
      const pendingJobs = jobs.filter(j => j.status === 'pending');
      document.getElementById('admin-pending-jobs').innerHTML = pendingJobs.map(job => `
        <div class="admin-item">
          <div class="admin-item-header">
            <div><strong>#${job.displayId}</strong> - ${job.posterName}</div>
            <div>Tasks: ${job.totalTasks}</div>
          </div>
          <div>Rate: ‡ß≥${job.ratePerTask.toFixed(3)} | Total: ‡ß≥${job.totalCost.toFixed(2)}</div>
          <div>Link: <a href="${job.adsteraLink}" target="_blank">${job.adsteraLink.substring(0, 30)}...</a></div>
          <input type="text" id="newlink-${job.id}" class="admin-link-input" placeholder="New link (optional)">
          <div class="admin-actions">
            <button class="btn btn-secondary" onclick="approveJobWithLink('${job.id}')">Approve</button>
            <button class="btn btn-warning" onclick="rejectJob('${job.id}')">Reject</button>
          </div>
        </div>
      `).join('') || '<div class="empty-history">No pending jobs</div>';

      // Deposit requests
      const pendingDeposits = depositRequests.filter(r => r.status === 'pending');
      document.getElementById('admin-deposit-requests').innerHTML = pendingDeposits.map(req => `
        <div class="admin-item">
          <div>${req.userName} (ID: ${req.userId})</div>
          <div>Amount: ‡ß≥${req.amount} | Method: ${req.method}</div>
          <div>TRX: ${req.trxId}</div>
          <div class="admin-actions">
            <button class="btn btn-secondary" onclick="approveDeposit('${req.id}')">Approve</button>
            <button class="btn btn-warning" onclick="rejectDeposit('${req.id}')">Reject</button>
          </div>
        </div>
      `).join('') || '<div class="empty-history">No pending deposits</div>';

      // Withdraw requests
      const pendingWithdraws = withdrawRequests.filter(r => r.status === 'pending');
      document.getElementById('admin-withdraw-requests').innerHTML = pendingWithdraws.map(req => `
        <div class="admin-item">
          <div>${req.userName} (ID: ${req.userId})</div>
          <div>Amount: ‡ß≥${req.amount} | Method: ${req.method}</div>
          <div>Address: ${req.address}</div>
          <div>Payout: ‡ß≥${req.payout} (${COMMISSION_PERCENT}% commission)</div>
          <div class="admin-actions">
            <button class="btn btn-secondary" onclick="approveWithdraw('${req.id}')">Approve</button>
            <button class="btn btn-warning" onclick="rejectWithdraw('${req.id}')">Reject</button>
          </div>
        </div>
      `).join('') || '<div class="empty-history">No pending withdrawals</div>';

      // Active jobs
      const activeJobs = jobs.filter(j => j.status === 'active' && !j.expired);
      document.getElementById('admin-active-jobs').innerHTML = activeJobs.map(job => `
        <div class="admin-item">
          <div class="admin-item-header">
            <div><strong>#${job.displayId}</strong> - ${job.posterName}</div>
            <div>Progress: ${job.completedTasks}/${job.totalTasks}</div>
          </div>
          <div>Link: <a href="${job.adsteraLink}" target="_blank">${job.adsteraLink.substring(0, 30)}...</a></div>
          <input type="text" id="updatelink-${job.id}" class="admin-link-input" value="${job.adsteraLink}">
          <button class="btn btn-secondary" onclick="updateJobLink('${job.id}')">Update Link</button>
        </div>
      `).join('') || '<div class="empty-history">No active jobs</div>';

      // Expired jobs
      const expiredJobs = jobs.filter(j => j.status === 'expired' || j.expired);
      document.getElementById('admin-expired-jobs').innerHTML = expiredJobs.map(job => `
        <div class="admin-item">
          <div class="admin-item-header">
            <div><strong>#${job.displayId}</strong> - ${job.posterName}</div>
            <div>Status: Expired</div>
          </div>
          <div>Rate: ‡ß≥${job.ratePerTask.toFixed(3)} | Tasks: ${job.completedTasks}/${job.totalTasks}</div>
          <textarea id="msg-${job.id}" class="admin-message-input" placeholder="Message to user..."></textarea>
          <button class="btn btn-warning" onclick="sendMessageToUser('${job.posterId}', '${job.id}')">Send Message</button>
        </div>
      `).join('') || '<div class="empty-history">No expired jobs</div>';
    }

    function approveJobWithLink(jobId) {
      const newLink = document.getElementById(`newlink-${jobId}`).value;
      approveJob(jobId, newLink || null);
      loadAdminPanel();
    }

    function updateJobLink(jobId) {
      const newLink = document.getElementById(`updatelink-${jobId}`).value;
      const job = jobs.find(j => j.id === jobId);
      if (job && newLink) {
        job.adsteraLink = newLink;
        saveJobs();
        showNotification("Job link updated!", "success");
      }
    }

    function sendMessageToUser(userId, jobId) {
      const msg = document.getElementById(`msg-${jobId}`).value;
      if (!msg) return;
      sendTelegramMessage(userId, `üì¢ <b>Admin Message regarding Job #${jobId}</b>\n\n${msg}`);
      showNotification("Message sent to user", "success");
    }

    // ==================== TELEGRAM FUNCTIONS ====================
    async function sendTelegramMessage(chatId, message, buttons = null) {
      try {
        const payload = {
          chat_id: chatId,
          text: message,
          parse_mode: 'HTML'
        };
        if (buttons) {
          payload.reply_markup = { inline_keyboard: buttons };
        }
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (error) {
        console.error('Telegram error:', error);
      }
    }

    function openSupport() {
      // Replace with your support link (Telegram, WhatsApp, etc.)
      window.open('https://t.me/youradmin');
    }

    // ==================== UI FUNCTIONS ====================
    function show(section) {
      document.getElementById("home-profile").style.display = "none";
      document.getElementById("home-content").style.display = "none";
      document.getElementById("earn").style.display = "none";
      document.getElementById("post-job").style.display = "none";
      document.getElementById("my-jobs").style.display = "none";
      document.getElementById("withdraw").style.display = "none";
      document.getElementById("deposit").style.display = "none";
      document.getElementById("profile-page").style.display = "none";
      
      if (section === 'home') {
        document.getElementById("home-profile").style.display = "block";
        document.getElementById("home-content").style.display = "block";
      } else if (section === 'earn') {
        document.getElementById("earn").style.display = "block";
        displayAvailableJobs();
      } else if (section === 'post-job') {
        document.getElementById("post-job").style.display = "block";
        updatePricing();
        // Show active job count
        const activeJobs = jobs.filter(j => j.posterId === userData.userId && j.status === 'active').length;
        document.getElementById('active-jobs-count').textContent = `${activeJobs}/1`;
      } else if (section === 'my-jobs') {
        document.getElementById("my-jobs").style.display = "block";
        displayMyJobs();
      } else if (section === 'withdraw') {
        document.getElementById("withdraw").style.display = "block";
        updateWithdrawHistory();
        // Do not call deposit history here
      } else if (section === 'deposit') {
        document.getElementById("deposit").style.display = "block";
        updateDepositHistory(); // update deposit history when deposit section is shown
      } else if (section === 'profile') {
        document.getElementById("profile-page").style.display = "block";
        updateReferralHistory();
        updateTransactionHistory();
      }
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById("nav-" + section).classList.add('active');
    }

    function updateDisplay() {
      if (!userData) return;

      // Header
      document.getElementById("header-balance").textContent = userData.balance.toFixed(2);

      // Home Profile
      document.getElementById("user-name").textContent = userData.firstName + (userData.lastName ? ' ' + userData.lastName : '');
      document.getElementById("display-user-id").textContent = userData.userId;
      document.getElementById("profile-img").src = userData.photoUrl;
      // Today's earning - calculate from today's transactions
      const today = new Date().toLocaleDateString();
      const todayEarn = (userData.transactions || [])
        .filter(t => t.type === 'task_complete' && new Date(t.date).toLocaleDateString() === today)
        .reduce((sum, t) => sum + t.amount, 0);
      document.getElementById("today-earning").textContent = todayEarn.toFixed(2);
      document.getElementById("lifetime-earning").textContent = userData.lifetimeEarning.toFixed(2);
      document.getElementById("total-tasks").textContent = userData.totalTasks;
      document.getElementById("referral-count").textContent = userData.referrals || 0;

      // Withdraw
      document.getElementById("available-balance").textContent = userData.balance.toFixed(2);
      document.getElementById("total-withdrawn").textContent = userData.withdrew.toFixed(2);
      document.getElementById("withdraw-referrals").textContent = userData.referrals || 0;

      // Profile
      document.getElementById("profile-name").textContent = userData.firstName + (userData.lastName ? ' ' + userData.lastName : '');
      document.getElementById("profile-user-id").textContent = userData.userId;
      document.getElementById("profile-page-img").src = userData.photoUrl;
      document.getElementById("profile-username").textContent = '@' + (userData.username || 'user' + userData.userId);
      
      const joinDate = new Date(userData.joinDate);
      document.getElementById("member-since").textContent = joinDate.toLocaleDateString();

      // Referral link
      const refLink = `https://t.me/TaskTycoon_Bot?start=ref_${userData.userId}`;
      document.getElementById("referral-link").textContent = refLink;
      document.getElementById("total-referrals").textContent = userData.referrals || 0;
      document.getElementById("referral-earnings").textContent = (userData.referralEarnings || 0).toFixed(2);
    }

    function updateStorage() {
      localStorage.setItem(`userData_${userData.userId}`, JSON.stringify(userData));
    }

    function loadRequests() {
      withdrawRequests = JSON.parse(localStorage.getItem('withdrawRequests')) || [];
      depositRequests = JSON.parse(localStorage.getItem('depositRequests')) || [];
    }

    function saveRequests() {
      localStorage.setItem('withdrawRequests', JSON.stringify(withdrawRequests));
      localStorage.setItem('depositRequests', JSON.stringify(depositRequests));
    }

    function showNotification(message, type) {
      const notification = document.getElementById("notification");
      const messageElement = document.getElementById("notification-message");
      
      messageElement.textContent = message;
      notification.className = "notification " + (type || "success");
      notification.classList.add("show");
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 3000);
    }

    // History functions
    function updateWithdrawHistory() {
      const userWithdrawals = withdrawRequests.filter(r => r.userId === userData.userId).slice(0, 5);
      const container = document.getElementById('withdrawal-history');
      if (userWithdrawals.length === 0) {
        container.innerHTML = '<div class="empty-history">No withdrawals yet</div>';
        return;
      }
      container.innerHTML = userWithdrawals.map(w => `
        <div class="history-item">
          <div class="history-info">
            <span class="history-date">${new Date(w.date).toLocaleDateString()}</span>
            <span class="history-type">Withdraw via ${w.method}</span>
          </div>
          <div>
            <span class="history-amount negative">-‡ß≥${w.amount.toFixed(2)}</span>
            <div><span class="status-badge status-${w.status}">${w.status}</span></div>
          </div>
        </div>
      `).join('');
    }

    function updateDepositHistory() {
      const userDeposits = depositRequests.filter(r => r.userId === userData.userId).slice(0, 5);
      const container = document.getElementById('deposit-history');
      if (userDeposits.length === 0) {
        container.innerHTML = '<div class="empty-history">No deposits yet</div>';
        return;
      }
      container.innerHTML = userDeposits.map(d => `
        <div class="history-item">
          <div class="history-info">
            <span class="history-date">${new Date(d.date).toLocaleDateString()}</span>
            <span class="history-type">Deposit via ${d.method}</span>
          </div>
          <div>
            <span class="history-amount positive">+‡ß≥${d.amount.toFixed(2)}</span>
            <div><span class="status-badge status-${d.status}">${d.status}</span></div>
          </div>
        </div>
      `).join('');
    }

    function updateReferralHistory() {
      // For simplicity, show referrals from user's data (if stored)
      const container = document.getElementById('referral-history');
      container.innerHTML = '<div class="empty-history">No referral history yet</div>';
    }

    function updateTransactionHistory() {
      const transactions = (userData.transactions || []).slice(-10).reverse();
      const container = document.getElementById('transaction-history');
      if (transactions.length === 0) {
        container.innerHTML = '<div class="empty-history">No transactions</div>';
        return;
      }
      container.innerHTML = transactions.map(t => `
        <div class="history-item">
          <div class="history-info">
            <span class="history-date">${new Date(t.date).toLocaleDateString()}</span>
            <span class="history-type">${t.type}</span>
          </div>
          <div>
            <span class="history-amount ${t.amount > 0 ? 'positive' : 'negative'}">
              ${t.amount > 0 ? '+' : ''}‡ß≥${t.amount.toFixed(2)}
            </span>
            <div><span class="status-badge status-${t.status}">${t.status}</span></div>
          </div>
        </div>
      `).join('');
    }

    function copyReferralLink() {
      const refLink = `https://t.me/TaskTycoon_Bot?start=ref_${userData.userId}`;
      navigator.clipboard.writeText(refLink)
        .then(() => showNotification("‚úÖ Referral link copied!", "success"))
        .catch(() => showNotification("Failed to copy link", "error"));
    }

    function shareJob(jobDisplayId) {
      const shareText = `üí∞ Earn money by completing tasks! Check out Job #${jobDisplayId} on Task Tycoon Bot.`;
      if (navigator.share) {
        navigator.share({
          title: 'Task Tycoon Job',
          text: shareText,
          url: 'https://t.me/TaskTycoon_Bot'
        }).catch(() => copyToClipboard(shareText));
      } else {
        copyToClipboard(shareText);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => showNotification("Copied to clipboard!", "success"))
        .catch(() => showNotification("Failed to copy", "error"));
    }

    // ==================== EXPOSE FUNCTIONS ====================
    window.show = show;
    window.viewAd = viewAd;
    window.submitJobPost = submitJobPost;
    window.submitWithdrawal = submitWithdrawal;
    window.submitDeposit = submitDeposit;
    window.copyReferralLink = copyReferralLink;
    window.shareJob = shareJob;
    window.toggleAdminPanel = toggleAdminPanel;
    window.approveJobWithLink = approveJobWithLink;
    window.rejectJob = function(jobId) {
      const job = jobs.find(j => j.id === jobId);
      if (job) {
        job.status = 'rejected';
        // Refund user
        const userKey = `userData_${job.posterId}`;
        const user = JSON.parse(localStorage.getItem(userKey));
        if (user) {
          user.balance += job.totalCost;
          localStorage.setItem(userKey, JSON.stringify(user));
        }
        saveJobs();
        loadAdminPanel();
        showNotification("Job rejected and user refunded", "warning");
        
        sendTelegramMessage(job.posterId, `
‚ùå <b>Your Job #${job.displayId} Has Been Rejected</b>

The amount of ‡ß≥${job.totalCost.toFixed(2)} has been refunded to your balance.
        `);
      }
    };
    window.updateJobLink = updateJobLink;
    window.sendMessageToUser = sendMessageToUser;
    window.approveWithdraw = approveWithdraw;
    window.rejectWithdraw = rejectWithdraw;
    window.approveDeposit = approveDeposit;
    window.rejectDeposit = rejectDeposit;
    window.calculatePayout = calculatePayout;
    window.openSupport = openSupport;
    window.showUpdateJob = showUpdateJob;
    window.cancelUpdate = cancelUpdate;
    window.confirmUpdate = confirmUpdate;
  </script>
</body>
</html>
