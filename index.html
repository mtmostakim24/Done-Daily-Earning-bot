<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Tycoon Bot | Premium Earning Platform</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; min-height: 100vh; padding-bottom: 70px; overflow-x: hidden; }
    body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 50%, rgba(102,126,234,0.3) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(118,75,162,0.3) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    .container { position: relative; z-index: 1; }

    .notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg,#4CAF50,#45a049); color: white; padding: 18px 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); display: flex; align-items: center; z-index: 1000; transform: translateX(150%); transition: transform 0.4s cubic-bezier(0.68,-0.55,0.265,1.55); max-width: 320px; }
    .notification.show { transform: translateX(0); }
    .notification.error { background: linear-gradient(135deg,#f44336,#e91e63); }
    .notification.warning { background: linear-gradient(135deg,#ff9800,#ff5722); }

    header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; background: rgba(0,0,0,0.25); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .title { display: flex; align-items: center; font-size: 20px; font-weight: bold; }
    .title i { margin-right: 10px; font-size: 26px; color: #ffd700; animation: rotate 3s linear infinite; }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .balance-display { display: flex; align-items: center; background: linear-gradient(135deg, rgba(76,175,80,0.3), rgba(56,142,60,0.3)); padding: 10px 18px; border-radius: 25px; font-weight: bold; border: 2px solid rgba(76,175,80,0.5); }

    .profile-container { padding: 20px; }
    .profile { background: rgba(255,255,255,0.15); border-radius: 20px; padding: 25px; backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.2); animation: slideUp 0.5s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .profile-header { display: flex; align-items: center; margin-bottom: 25px; }
    .profile-img-container { width: 80px; height: 80px; border-radius: 50%; overflow: hidden; margin-right: 18px; border: 4px solid #ffd700; box-shadow: 0 4px 15px rgba(255,215,0,0.4); position: relative; }
    .profile-img-container img { width: 100%; height: 100%; object-fit: cover; }
    .profile-info { flex: 1; }
    .name { font-size: 20px; font-weight: bold; margin-bottom: 6px; }
    .user-id { font-size: 14px; opacity: 0.9; background: rgba(0,0,0,0.2); padding: 4px 12px; border-radius: 12px; display: inline-block; }
    .stats-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 15px; margin-top: 20px; }
    .stat-item { background: linear-gradient(135deg,rgba(0,0,0,0.3),rgba(0,0,0,0.2)); padding: 18px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; cursor: pointer; }
    .stat-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    .stat-value { font-size: 24px; font-weight: bold; color: #ffd700; margin-bottom: 8px; }
    .stat-label { font-size: 13px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }

    .cards-container { padding: 0 20px 20px; }
    .card { background: rgba(255,255,255,0.15); border-radius: 20px; padding: 25px; margin-bottom: 20px; backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.2); animation: slideUp 0.5s ease-out; }
    .card-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.15); padding-bottom: 15px; }
    .card-header i { font-size: 26px; margin-right: 12px; color: #ffd700; }
    .card-header h3 { font-size: 19px; font-weight: bold; }

    .info-row { display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.15); border-radius: 10px; }
    .info-label { font-size: 14px; opacity: 0.9; }
    .info-value { font-size: 15px; font-weight: bold; color: #ffd700; }

    .progress-container { background: rgba(0,0,0,0.3); height: 12px; border-radius: 10px; overflow: hidden; margin: 15px 0; }
    .progress-bar { height: 100%; background: linear-gradient(90deg,#4CAF50,#8BC34A,#4CAF50); background-size: 200% 100%; border-radius: 10px; width: 0%; transition: width 0.5s ease; animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .progress-info { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 15px; font-weight: 500; }

    .btn { background: linear-gradient(135deg,#4CAF50,#2E7D32); color: white; border: none; padding: 15px 24px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; display: block; width: 100%; text-align: center; transition: all 0.3s ease; margin-top: 15px; box-shadow: 0 5px 15px rgba(76,175,80,0.4); position: relative; overflow: hidden; }
    .btn:hover { transform: translateY(-3px); }
    .btn:active { transform: translateY(-1px); }
    .btn-secondary { background: linear-gradient(135deg,#2196F3,#0D47A1); box-shadow: 0 5px 15px rgba(33,150,243,0.4); }
    .btn-warning { background: linear-gradient(135deg,#ff9800,#f57c00); box-shadow: 0 5px 15px rgba(255,152,0,0.4); }
    .btn-purple { background: linear-gradient(135deg,#9C27B0,#7B1FA2); box-shadow: 0 5px 15px rgba(156,39,176,0.4); }
    .btn-navy { background: linear-gradient(135deg,#1a237e,#283593); box-shadow: 0 5px 15px rgba(26,35,126,0.4); }
    .btn-green { background: linear-gradient(135deg,#2e7d32,#388e3c); box-shadow: 0 5px 15px rgba(46,125,50,0.4); }
    .btn:disabled { background: linear-gradient(135deg,#9e9e9e,#757575); cursor: not-allowed; opacity: 0.6; }

    .input-group { margin-bottom: 20px; }
    .input-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 14px 18px; border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(255,255,255,0.1); color: white; font-size: 15px; transition: all 0.3s ease; backdrop-filter: blur(10px); }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #ffd700; background: rgba(255,255,255,0.15); box-shadow: 0 0 15px rgba(255,215,0,0.3); }
    select option { background: #2c3e50; color: white; }

    /* Home Action Buttons */
    .home-actions { display: flex; gap: 12px; margin: 20px 0 10px; }
    .home-actions .btn { flex: 1; margin-top: 0; padding: 14px 10px; font-size: 15px; }

    /* Social Links */
    .social-links { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .social-link-btn { display: flex; align-items: center; gap: 12px; padding: 12px 18px; border-radius: 12px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; color: white; transition: all 0.3s ease; width: 100%; }
    .social-link-btn:hover { transform: translateX(5px); }
    .social-tg { background: linear-gradient(135deg,#229ED9,#1a7fc1); }
    .social-yt { background: linear-gradient(135deg,#FF0000,#cc0000); }
    .social-fb { background: linear-gradient(135deg,#1877F2,#0d5dbf); }
    .social-link-btn i { font-size: 20px; }

    /* Support Chat Button */
    .support-fab { position: fixed; bottom: 80px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(135deg,#ffd700,#ffa000); border: none; cursor: pointer; z-index: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 24px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { box-shadow: 0 4px 15px rgba(255,215,0,0.4); } 50% { box-shadow: 0 4px 25px rgba(255,215,0,0.8); } }

    /* Job Items */
    .job-item { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
    .job-item:hover { transform: translateX(5px); background: rgba(0,0,0,0.3); }
    .job-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .job-user { display: flex; align-items: center; gap: 10px; }
    .job-user i { font-size: 24px; color: #ffd700; }
    .job-user-info { display: flex; flex-direction: column; }
    .job-username { font-weight: bold; font-size: 16px; }
    .job-poster { font-size: 12px; opacity: 0.8; }
    .job-price { font-size: 20px; font-weight: bold; color: #4CAF50; }
    .job-price.high { color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
    .job-footer { display: flex; gap: 10px; margin-top: 15px; }
    .job-footer .btn { flex: 1; margin-top: 0; }

    /* Timer badge on job */
    .job-timer-badge { background: rgba(255,215,0,0.2); border: 1px solid #ffd700; color: #ffd700; font-size: 12px; font-weight: bold; padding: 3px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px; }

    /* Status Badges */
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
    .status-pending { background: #ff9800; color: white; }
    .status-active { background: #4CAF50; color: white; }
    .status-completed { background: #2196F3; color: white; }
    .status-rejected { background: #f44336; color: white; }
    .status-approved { background: #4CAF50; color: white; }

    /* History */
    .history-item { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.08); }
    .history-item .amount-pos { color: #4CAF50; font-weight: bold; }
    .history-item .amount-neg { color: #f44336; font-weight: bold; }
    .history-meta { font-size: 12px; opacity: 0.7; margin-top: 3px; }
    .empty-history { text-align: center; opacity: 0.6; padding: 20px; }

    /* Referral link */
    .referral-link-container { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; margin-bottom: 15px; word-break: break-all; font-size: 13px; }
    .referral-link { margin-bottom: 10px; color: #ffd700; }

    /* Admin Panel */
    .admin-panel { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; overflow-y: auto; padding: 20px; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .admin-close { font-size: 30px; cursor: pointer; color: #ffd700; }
    .admin-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .admin-tab { padding: 8px 14px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s; }
    .admin-tab.active { background: #ffd700; color: #000; }
    .admin-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; display: none; }
    .admin-section.active { display: block; }
    .admin-section h3 { margin-bottom: 20px; color: #ffd700; }
    .admin-job-item { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
    .admin-job-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .admin-job-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .admin-link-input { width: 100%; padding: 8px; margin: 10px 0; border-radius: 8px; border: 1px solid #ffd700; background: rgba(0,0,0,0.5); color: white; }
    .admin-msg-input { width: 100%; padding: 8px; margin: 8px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5); color: white; }

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.15); z-index: 100; }
    .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; transition: all 0.3s ease; position: relative; }
    .nav-item::before { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 3px; background: #ffd700; transition: width 0.3s ease; }
    .nav-item.active::before { width: 60%; }
    .nav-item.active { color: #ffd700; }
    .nav-item i { display: block; font-size: 22px; margin-bottom: 4px; }
    .nav-item span { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Payout preview */
    .payout-preview { background: rgba(76,175,80,0.2); border: 1px solid #4CAF50; border-radius: 10px; padding: 12px 15px; margin: 10px 0; font-weight: bold; font-size: 16px; text-align: center; }

    /* Job subscription warning */
    .subscription-warning { background: rgba(255,152,0,0.2); border: 1px solid #ff9800; border-radius: 10px; padding: 12px 15px; margin: 10px 0; font-size: 13px; }

    @media (max-width: 480px) {
      .title { font-size: 18px; }
      .balance-display { padding: 8px 14px; font-size: 14px; }
      .profile { padding: 20px; }
      .btn { padding: 12px 20px; font-size: 14px; }
    }
  </style>
</head>
<body>
<div class="container">

  <!-- Notification -->
  <div id="notification" class="notification">
    <i class="fas fa-check-circle" style="margin-right:10px;"></i>
    <span id="notification-message"></span>
  </div>

  <!-- Header -->
  <header>
    <div class="title">
      <i class="fas fa-coins"></i>
      Task Tycoon Bot
    </div>
    <div class="balance-display">
      <i class="fas fa-wallet" style="margin-right:8px;"></i>
      ‡ß≥<span id="header-balance">0.00</span>
    </div>
  </header>

  <!-- Support FAB Button -->
  <button class="support-fab" onclick="openSupport()" title="Support">
    üí¨
  </button>

  <!-- Admin Panel -->
  <div id="admin-panel" class="admin-panel">
    <div class="admin-header">
      <h2>‚ö° Admin Panel</h2>
      <div class="admin-close" onclick="toggleAdminPanel()">‚úï</div>
    </div>
    <div class="admin-tabs">
      <div class="admin-tab active" onclick="switchAdminTab('pending-jobs')">üìã Pending Jobs</div>
      <div class="admin-tab" onclick="switchAdminTab('deposit-req')">üí≥ Deposits</div>
      <div class="admin-tab" onclick="switchAdminTab('withdraw-req')">üí∏ Withdrawals</div>
      <div class="admin-tab" onclick="switchAdminTab('active-jobs')">‚úÖ Active Jobs</div>
      <div class="admin-tab" onclick="switchAdminTab('expired-jobs')">‚ö†Ô∏è Expired Jobs</div>
    </div>

    <div id="admin-pending-jobs" class="admin-section active">
      <h3>üìã Pending Jobs</h3>
      <div id="admin-pending-jobs-list"></div>
    </div>
    <div id="admin-deposit-req" class="admin-section">
      <h3>üí≥ Deposit Requests</h3>
      <div id="admin-deposit-list"></div>
    </div>
    <div id="admin-withdraw-req" class="admin-section">
      <h3>üí∏ Withdrawal Requests</h3>
      <div id="admin-withdraw-list"></div>
    </div>
    <div id="admin-active-jobs" class="admin-section">
      <h3>‚úÖ Active Jobs</h3>
      <div id="admin-active-jobs-list"></div>
    </div>
    <div id="admin-expired-jobs" class="admin-section">
      <h3>‚ö†Ô∏è Jobs Not Updated (Subscription Expired)</h3>
      <div id="admin-expired-jobs-list"></div>
    </div>
  </div>

  <!-- HOME Profile -->
  <div id="home-profile" class="profile-container">
    <div class="profile">
      <div class="profile-header">
        <div class="profile-img-container">
          <img id="profile-img" src="https://via.placeholder.com/80" alt="Profile">
        </div>
        <div class="profile-info">
          <div class="name" id="user-name">Loading...</div>
          <div class="user-id">ID: <span id="display-user-id">------</span></div>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">‡ß≥<span id="today-earning">0.00</span></div>
          <div class="stat-label">Today's Earning</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">‡ß≥<span id="lifetime-earning">0.00</span></div>
          <div class="stat-label">Total Earned</div>
        </div>
        <div class="stat-item">
          <div class="stat-value"><span id="total-tasks">0</span></div>
          <div class="stat-label">Tasks Completed</div>
        </div>
        <div class="stat-item">
          <div class="stat-value"><span id="referral-count">0</span></div>
          <div class="stat-label">Referrals</div>
        </div>
      </div>
    </div>
  </div>

  <!-- HOME Content -->
  <div id="home-content" class="cards-container">
    <!-- Deposit & Withdraw Buttons -->
    <div class="home-actions">
      <button class="btn btn-green" onclick="show('deposit')">
        <i class="fas fa-plus-circle"></i> Deposit
      </button>
      <button class="btn btn-navy" onclick="show('withdraw')">
        <i class="fas fa-paper-plane"></i> Withdrew
      </button>
    </div>

    <!-- Social Links -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-share-alt"></i>
        <h3>Join Our Community</h3>
      </div>
      <div class="social-links">
        <button class="social-link-btn social-tg" onclick="openLink('https://t.me/YourChannel')">
          <i class="fab fa-telegram"></i>
          <span>‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ú‡¶Ø‡¶º‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
        </button>
        <button class="social-link-btn social-yt" onclick="openLink('https://youtube.com/@YourChannel')">
          <i class="fab fa-youtube"></i>
          <span>‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶á‡¶â‡¶ü‡¶ø‡¶â‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡¶æ‡¶¨‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶æ‡¶á‡¶¨ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
        </button>
        <button class="social-link-btn social-fb" onclick="openLink('https://facebook.com/YourPage')">
          <i class="fab fa-facebook"></i>
          <span>‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶™‡ßá‡¶ú ‡¶´‡¶≤‡ßã ‡¶ï‡¶∞‡ßÅ‡¶®</span>
        </button>
      </div>
    </div>
  </div>

  <!-- EARN Section -->
  <div id="earn" class="cards-container" style="display:none;">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-tasks"></i>
        <h3>Available Jobs</h3>
      </div>
      <div id="available-jobs-list"></div>
    </div>
  </div>

  <!-- POST JOB Section -->
  <div id="post-job" class="cards-container" style="display:none;">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-plus-circle"></i>
        <h3>Post a New Job</h3>
      </div>
      <div id="existing-job-warning" style="display:none;" class="subscription-warning">
        ‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø active job ‡¶Ü‡¶õ‡ßá‡•§ ‡¶è‡¶ï‡¶ú‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ï‡¶ü‡¶ø job post ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§
        My Jobs ‡¶Ö‡¶™‡¶∂‡¶®‡ßá ‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ job update ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
      </div>
      <div id="job-post-form">
        <div class="info-row" style="background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);">
          <span class="info-label">üí° ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶® ‡¶´‡ßç‡¶∞‡¶ø‡•§ ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®‡ßá ‡ß≥‡ßß‡ß¶‡ß¶ ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú‡•§</span>
        </div>

        <div class="input-group">
          <label class="input-label">Adstera Smart Link</label>
          <input type="text" id="job-adstera" placeholder="https://your-adstera-link.com" required>
        </div>
        <div class="input-group">
          <label class="input-label">Number of Tasks</label>
          <select id="job-tasks" onchange="updatePricing()">
            <option value="1000">1,000 Tasks</option>
            <option value="2000">2,000 Tasks</option>
            <option value="3000">3,000 Tasks</option>
            <option value="5000">5,000 Tasks</option>
            <option value="7000">7,000 Tasks</option>
            <option value="10000">10,000 Tasks</option>
          </select>
        </div>
        <div class="input-group">
          <label class="input-label">Pay per Task (Minimum ‡ß≥0.050)</label>
          <input type="number" id="job-rate" value="0.050" min="0.050" step="0.001" oninput="updatePricing()">
        </div>

        <div class="info-row">
          <span class="info-label">Base Price</span>
          <span class="info-value" id="base-price">‡ß≥50.00</span>
        </div>
        <div class="info-row">
          <span class="info-label">Additional Charge (+10%)</span>
          <span class="info-value" id="additional-charge">+ ‡ß≥5.00</span>
        </div>
        <div class="info-row" style="background:rgba(76,175,80,0.2);">
          <span class="info-label">Total Cost</span>
          <span class="info-value" id="total-cost" style="font-size:18px;">‡ß≥55.00</span>
        </div>
        <div class="info-row">
          <span class="info-label">Worker Will Get</span>
          <span class="info-value" id="worker-pay">‡ß≥0.050 per task</span>
        </div>

        <button class="btn" onclick="submitJobPost()">
          <i class="fas fa-cloud-upload-alt"></i> Submit Job for Approval
        </button>
      </div>
    </div>
  </div>

  <!-- MY JOBS Section -->
  <div id="my-jobs" class="cards-container" style="display:none;">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-briefcase"></i>
        <h3>My Posted Jobs</h3>
      </div>
      <div id="my-jobs-list"></div>
    </div>
  </div>

  <!-- WITHDRAW Section -->
  <div id="withdraw" class="cards-container" style="display:none;">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-money-bill-wave"></i>
        <h3>Withdraw Funds</h3>
      </div>
      <div class="info-row">
        <span class="info-label">Available Balance</span>
        <span class="info-value">‡ß≥<span id="available-balance">0.00</span></span>
      </div>
      <div class="info-row">
        <span class="info-label">Total Withdrawn</span>
        <span class="info-value">‡ß≥<span id="total-withdrawn">0.00</span></span>
      </div>
      <div class="info-row">
        <span class="info-label">Minimum Withdrawal</span>
        <span class="info-value">‡ß≥1500.00</span>
      </div>

      <div class="input-group">
        <label class="input-label">Amount (BDT)</label>
        <input type="number" id="withdraw-amount" placeholder="Enter amount" min="1500" step="1" oninput="calcPayout()">
      </div>
      <div class="payout-preview" id="payout-preview" style="display:none;">
        Payout Amount: ‡ß≥<span id="payout-amount">0.00</span>
        <div style="font-size:12px;opacity:0.8;">(-10% commission: ‡ß≥<span id="commission-amount">0.00</span>)</div>
      </div>

      <div class="input-group">
        <label class="input-label">Payment Method</label>
        <select id="withdraw-method">
          <option value="">Select a method</option>
          <option value="Bkash">Bkash</option>
          <option value="Nagad">Nagad</option>
          <option value="Rocket">Rocket</option>
        </select>
      </div>
      <div class="input-group">
        <label class="input-label">Payment Address</label>
        <input type="text" id="withdraw-address" placeholder="Enter payment address">
      </div>
      <button class="btn" onclick="submitWithdrawal()">
        <i class="fas fa-paper-plane"></i> Submit Withdrawal
      </button>
    </div>

    <!-- Withdrawal History -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-history"></i>
        <h3>Withdrawal History</h3>
      </div>
      <div id="withdrawal-history-list"></div>
    </div>

    <!-- Deposit History -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-credit-card"></i>
        <h3>Deposit History</h3>
      </div>
      <div id="deposit-history-list"></div>
    </div>
  </div>

  <!-- DEPOSIT Section -->
  <div id="deposit" class="cards-container" style="display:none;">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-credit-card"></i>
        <h3>Deposit Funds</h3>
      </div>
      <div class="info-row">
        <span class="info-label">Bkash (Personal)</span>
        <span class="info-value">017XXXXXXXX</span>
      </div>
      <div class="info-row">
        <span class="info-label">Nagad (Personal)</span>
        <span class="info-value">018XXXXXXXX</span>
      </div>
      <div class="info-row">
        <span class="info-label">Rocket (Personal)</span>
        <span class="info-value">019XXXXXXXX</span>
      </div>
      <div class="input-group">
        <label class="input-label">Amount (BDT)</label>
        <input type="number" id="deposit-amount" placeholder="Enter amount" min="100" step="1">
      </div>
      <div class="input-group">
        <label class="input-label">Payment Method</label>
        <select id="deposit-method">
          <option value="">Select a method</option>
          <option value="Bkash">Bkash</option>
          <option value="Nagad">Nagad</option>
          <option value="Rocket">Rocket</option>
        </select>
      </div>
      <div class="input-group">
        <label class="input-label">Transaction ID</label>
        <input type="text" id="deposit-trx" placeholder="Enter transaction ID">
      </div>
      <button class="btn btn-secondary" onclick="submitDeposit()">
        <i class="fas fa-paper-plane"></i> Submit Deposit
      </button>
    </div>
  </div>

  <!-- PROFILE Section -->
  <div id="profile-page" class="cards-container" style="display:none;">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-user"></i>
        <h3>Profile Information</h3>
      </div>
      <div class="profile-header">
        <div class="profile-img-container">
          <img id="profile-page-img" src="https://via.placeholder.com/80" alt="Profile">
        </div>
        <div class="profile-info">
          <div class="name" id="profile-name">Loading...</div>
          <div class="user-id">ID: <span id="profile-user-id">------</span></div>
        </div>
      </div>
      <div class="info-row">
        <span class="info-label">Username</span>
        <span class="info-value" id="profile-username">@username</span>
      </div>
      <div class="info-row">
        <span class="info-label">Member Since</span>
        <span class="info-value" id="member-since">Just now</span>
      </div>
    </div>

    <!-- Referral Program -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-users"></i>
        <h3>Referral Program</h3>
      </div>
      <div class="info-row" style="background:rgba(76,175,80,0.1);">
        <span class="info-label">üí° ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶ø +5% ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶™‡¶æ‡¶¨‡ßá‡¶®</span>
      </div>
      <div class="referral-link-container">
        <div class="referral-link" id="referral-link">Loading...</div>
        <button class="btn btn-secondary" onclick="copyReferralLink()" style="margin-top:8px;">
          <i class="fas fa-copy"></i> Copy Link
        </button>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="total-referrals">0</div>
          <div class="stat-label">Referrals</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">‡ß≥<span id="referral-earnings">0.00</span></div>
          <div class="stat-label">Ref Earnings</div>
        </div>
      </div>

      <!-- Referral History -->
      <h4 style="margin:15px 0 10px;color:#ffd700;">Referral History (Last 5)</h4>
      <div id="referral-history-list"></div>
    </div>

    <!-- Transaction History -->
    <div class="card">
      <div class="card-header">
        <i class="fas fa-list"></i>
        <h3>Transaction History (Last 10)</h3>
      </div>
      <div id="transaction-history-list"></div>
    </div>

    <div id="admin-access" style="display:none;">
      <button class="btn btn-purple" onclick="toggleAdminPanel()">
        <i class="fas fa-cog"></i> Admin Panel
      </button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="show('home')">
      <i class="fas fa-home"></i><span>Home</span>
    </div>
    <div class="nav-item" id="nav-earn" onclick="show('earn')">
      <i class="fas fa-coins"></i><span>Earn</span>
    </div>
    <div class="nav-item" id="nav-post-job" onclick="show('post-job')">
      <i class="fas fa-plus-circle"></i><span>Post</span>
    </div>
    <div class="nav-item" id="nav-my-jobs" onclick="show('my-jobs')">
      <i class="fas fa-briefcase"></i><span>My Jobs</span>
    </div>
    <div class="nav-item" id="nav-profile" onclick="show('profile')">
      <i class="fas fa-user"></i><span>Profile</span>
    </div>
  </div>

</div>

<script>
// ==================== CONFIGURATION ====================
const BOT_TOKEN = "8776517486:AAEofGA5QJ-XNfx37yMz4rc6RFk_l_Y9Wh0";
const ADMIN_CHAT_ID = "6892959740";
const MIN_RATE = 0.050;
const COMMISSION_RATE = 0.10; // 10% commission
const REFERRAL_COMMISSION = 0.05; // 5% referral commission
const JOB_CHARGE_DAYS = 30; // days
const JOB_RENEWAL_FEE = 100; // ‡ß≥100

const TASK_PRICES = {
  1000: { base: 50 }, 2000: { base: 100 }, 3000: { base: 150 },
  5000: { base: 250 }, 7000: { base: 350 }, 10000: { base: 500 }
};

// ==================== GLOBAL VARIABLES ====================
let userData = null;
let jobs = [];
let withdrawRequests = [];
let depositRequests = [];
let jobIdCounter = 0;

// ==================== INITIALIZATION ====================
let tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

window.addEventListener('DOMContentLoaded', function() {
  initializeUser();
  loadJobs();
  loadRequests();
  updateDisplay();
  setupEventListeners();
  checkAdminAccess();
  handleReferral();
});

function initializeUser() {
  let user = null;
  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
    user = tg.initDataUnsafe.user;
  } else {
    user = { id: 123456789, first_name: "Demo", last_name: "User", username: "demouser", photo_url: "https://via.placeholder.com/80" };
  }

  const storageKey = `userData_${user.id}`;
  const savedData = localStorage.getItem(storageKey);

  if (savedData) {
    userData = JSON.parse(savedData);
    // Ensure new fields exist
    if (!userData.referralHistory) userData.referralHistory = [];
    if (!userData.referralEarnings) userData.referralEarnings = 0;
    if (!userData.withdrawHistory) userData.withdrawHistory = [];
    if (!userData.depositHistory) userData.depositHistory = [];
    if (!userData.transactions) userData.transactions = [];
    if (userData.withdrew === undefined) userData.withdrew = 0;
    if (userData.deposited === undefined) userData.deposited = 0;
    if (userData.referrals === undefined) userData.referrals = 0;
  } else {
    userData = {
      userId: user.id,
      firstName: user.first_name,
      lastName: user.last_name || '',
      username: user.username || '',
      photoUrl: user.photo_url || 'https://via.placeholder.com/80',
      balance: 0,
      lifetimeEarning: 0,
      withdrew: 0,
      deposited: 0,
      totalTasks: 0,
      referrals: 0,
      referralEarnings: 0,
      referredBy: null,
      joinDate: new Date().toISOString(),
      transactions: [],
      withdrawHistory: [],
      depositHistory: [],
      referralHistory: [],
      isAdmin: false
    };
    localStorage.setItem(storageKey, JSON.stringify(userData));
  }
}

function handleReferral() {
  // Check if user was referred
  const startParam = tg?.initDataUnsafe?.start_param;
  if (startParam && startParam.startsWith('ref_') && !userData.referredBy) {
    const referrerId = parseInt(startParam.replace('ref_', ''));
    if (referrerId !== userData.userId) {
      userData.referredBy = referrerId;
      updateStorage();
      // Update referrer's count
      const refKey = `userData_${referrerId}`;
      const refUser = JSON.parse(localStorage.getItem(refKey));
      if (refUser) {
        refUser.referrals = (refUser.referrals || 0) + 1;
        localStorage.setItem(refKey, JSON.stringify(refUser));
      }
    }
  }
}

// ==================== JOB FUNCTIONS ====================
function loadJobs() {
  jobs = JSON.parse(localStorage.getItem('jobs')) || [];
  jobIdCounter = parseInt(localStorage.getItem('jobIdCounter') || '100');
}

function saveJobs() {
  localStorage.setItem('jobs', JSON.stringify(jobs));
  localStorage.setItem('jobIdCounter', jobIdCounter.toString());
}

function calculateJobCost(tasks, rate) {
  const baseCost = tasks * rate;
  const charge = baseCost * COMMISSION_RATE; // +10%
  return {
    baseCost: baseCost,
    charge: charge,
    total: baseCost + charge,
    workerPay: rate
  };
}

function updatePricing() {
  const tasks = parseInt(document.getElementById('job-tasks').value);
  const rate = parseFloat(document.getElementById('job-rate').value) || MIN_RATE;
  const cost = calculateJobCost(tasks, rate);
  document.getElementById('base-price').textContent = `‡ß≥${cost.baseCost.toFixed(2)}`;
  document.getElementById('additional-charge').textContent = `+ ‡ß≥${cost.charge.toFixed(2)}`;
  document.getElementById('total-cost').textContent = `‡ß≥${cost.total.toFixed(2)}`;
  document.getElementById('worker-pay').textContent = `‡ß≥${rate.toFixed(3)} per task`;
}

function setupEventListeners() {
  const tasksSelect = document.getElementById('job-tasks');
  const rateInput = document.getElementById('job-rate');
  if (tasksSelect) tasksSelect.addEventListener('change', updatePricing);
  if (rateInput) rateInput.addEventListener('input', updatePricing);
  updatePricing();
}

function submitJobPost() {
  // Check if user already has a job
  const userExistingJobs = jobs.filter(j => j.posterId === userData.userId && (j.status === 'pending' || j.status === 'active'));
  if (userExistingJobs.length > 0) {
    showNotification("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø job ‡¶Ü‡¶õ‡ßá! My Jobs ‡¶è ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§", "error");
    return;
  }

  const adsteraLink = document.getElementById('job-adstera').value.trim();
  const tasks = parseInt(document.getElementById('job-tasks').value);
  const rate = parseFloat(document.getElementById('job-rate').value);

  if (!adsteraLink) {
    showNotification("Please enter your Adstera Smart Link", "error");
    return;
  }
  if (rate < MIN_RATE) {
    showNotification(`Minimum rate is ‡ß≥${MIN_RATE.toFixed(3)} per task`, "error");
    return;
  }

  const cost = calculateJobCost(tasks, rate);

  if (userData.balance < cost.total) {
    showNotification("Insufficient balance! Please deposit first.", "error");
    show('deposit');
    return;
  }

  jobIdCounter++;
  const jobNumericId = jobIdCounter;
  const job = {
    id: 'JOB' + Date.now(),
    numericId: jobNumericId,
    posterId: userData.userId,
    posterName: userData.firstName + (userData.lastName ? ' ' + userData.lastName : ''),
    adsteraLink: adsteraLink,
    totalTasks: tasks,
    completedTasks: 0,
    ratePerTask: rate,
    totalCost: cost.total,
    status: 'pending',
    workers: [],
    completedByUsers: [],
    createdAt: new Date().toISOString(),
    lastRenewed: new Date().toISOString(),
    nextRenewal: new Date(Date.now() + JOB_CHARGE_DAYS * 24 * 3600 * 1000).toISOString(),
    approvedAdLink: null
  };

  // Deduct balance
  userData.balance -= cost.total;
  addTransaction('job_post', -cost.total, 'completed', `Job #${jobNumericId} Posted`);
  jobs.push(job);
  saveJobs();
  updateStorage();
  updateDisplay();

  showNotification("Job submitted! Waiting for admin approval.", "success");

  // Notify admin
  sendTelegramMessage(ADMIN_CHAT_ID, `
üìã <b>NEW JOB PENDING APPROVAL</b>

üÜî Job ID: <code>${jobNumericId}</code>
üë§ User: ${job.posterName} (ID: ${userData.userId})
üìä Tasks: ${job.totalTasks.toLocaleString()}
üí∞ Rate: ‡ß≥${job.ratePerTask.toFixed(3)}/task
üíµ Total Cost: ‡ß≥${job.totalCost.toFixed(2)}
üîó Adstera Link: ${adsteraLink}
`);

  document.getElementById('job-adstera').value = '';
  document.getElementById('job-rate').value = MIN_RATE.toFixed(3);
  updatePricing();
  show('my-jobs');
}

// Display available jobs
function displayAvailableJobs() {
  const container = document.getElementById('available-jobs-list');
  const activeJobs = jobs.filter(j => j.status === 'active' && j.completedTasks < j.totalTasks);

  if (activeJobs.length === 0) {
    container.innerHTML = '<div class="empty-history">No jobs available right now</div>';
    return;
  }

  activeJobs.sort((a, b) => b.ratePerTask - a.ratePerTask);
  container.innerHTML = '';

  activeJobs.forEach(job => {
    // Skip jobs already completed by this user today
    const today = new Date().toLocaleDateString();
    const userDoneToday = job.workers.some(w => w.userId === userData.userId && new Date(w.completedAt).toLocaleDateString() === today);
    
    const remaining = job.totalTasks - job.completedTasks;
    const progress = (job.completedTasks / job.totalTasks * 100).toFixed(1);
    const isHighRate = job.ratePerTask > MIN_RATE + 0.005;

    const jobDiv = document.createElement('div');
    jobDiv.className = 'job-item';
    jobDiv.innerHTML = `
      <div class="job-header">
        <div class="job-user">
          <i class="fas fa-briefcase"></i>
          <div class="job-user-info">
            <div class="job-username">Job #${job.numericId}</div>
            <div class="job-poster">Posted by ${job.posterName}</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
          <div class="job-price ${isHighRate ? 'high' : ''}">‡ß≥${job.ratePerTask.toFixed(3)}</div>
          <div class="job-timer-badge"><i class="fas fa-clock"></i> 15s</div>
        </div>
      </div>
      <div class="progress-info">
        <span>Completed: ${job.completedTasks}/${job.totalTasks}</span>
        <span>Remaining: ${remaining}</span>
      </div>
      <div class="progress-container">
        <div class="progress-bar" style="width:${progress}%;"></div>
      </div>
      <div class="job-footer">
        <button class="btn" onclick="viewAd('${job.id}')" ${userDoneToday ? 'disabled' : ''}>
          <i class="fas fa-play"></i> ${userDoneToday ? 'Done Today' : 'View Ad'}
        </button>
      </div>
    `;
    container.appendChild(jobDiv);
  });
}

// Display my jobs
function displayMyJobs() {
  const container = document.getElementById('my-jobs-list');
  const userJobs = jobs.filter(j => j.posterId === userData.userId);

  if (userJobs.length === 0) {
    container.innerHTML = '<div class="empty-history">You haven\'t posted any jobs yet</div>';
    return;
  }

  userJobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  container.innerHTML = '';

  userJobs.forEach(job => {
    const remaining = job.totalTasks - job.completedTasks;
    const progress = (job.completedTasks / job.totalTasks * 100).toFixed(1);
    const isCompleted = job.completedTasks >= job.totalTasks;
    const isExpired = isSubscriptionExpired(job);
    const nextRenewal = new Date(job.nextRenewal).toLocaleDateString();

    const jobDiv = document.createElement('div');
    jobDiv.className = 'job-item';
    jobDiv.innerHTML = `
      <div class="job-header">
        <div class="job-user">
          <i class="fas fa-briefcase"></i>
          <div class="job-user-info">
            <div class="job-username">Job #${job.numericId}</div>
            <div class="job-poster">Status: <span class="status-badge status-${job.status}">${job.status}</span></div>
          </div>
        </div>
        <div class="job-price">‡ß≥${job.ratePerTask.toFixed(3)}</div>
      </div>
      <div class="progress-info">
        <span>Completed: ${job.completedTasks}/${job.totalTasks}</span>
        <span>Remaining: ${remaining}</span>
      </div>
      <div class="progress-container">
        <div class="progress-bar" style="width:${progress}%;"></div>
      </div>
      <div class="info-row">
        <span>Total Cost</span>
        <span>‡ß≥${job.totalCost.toFixed(2)}</span>
      </div>
      <div class="info-row">
        <span>Next Renewal</span>
        <span>${nextRenewal}</span>
      </div>
      ${isExpired ? `<div class="subscription-warning">‚ö†Ô∏è ‡¶∏‡¶æ‡¶¨‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑! ‡ß≥‡ßß‡ß¶‡ß¶ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∞‡¶ø‡¶®‡¶ø‡¶â ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
        <button class="btn btn-warning" style="margin-top:8px;" onclick="renewJob('${job.id}')">
          <i class="fas fa-sync"></i> Renew ‡ß≥100
        </button></div>` : ''}
      ${isCompleted && !isExpired ? `<button class="btn btn-secondary" style="margin-top:10px;" onclick="showJobUpdateForm('${job.id}')">
        <i class="fas fa-redo"></i> Update Job
      </button>` : ''}
      <div id="update-form-${job.id}" style="display:none;margin-top:15px;"></div>
    `;
    container.appendChild(jobDiv);
  });
}

function isSubscriptionExpired(job) {
  if (job.status !== 'active') return false;
  return new Date() > new Date(job.nextRenewal);
}

function renewJob(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  if (userData.balance < JOB_RENEWAL_FEE) {
    showNotification("Insufficient balance for renewal! Need ‡ß≥100.", "error");
    return;
  }
  userData.balance -= JOB_RENEWAL_FEE;
  job.lastRenewed = new Date().toISOString();
  job.nextRenewal = new Date(Date.now() + JOB_CHARGE_DAYS * 24 * 3600 * 1000).toISOString();
  addTransaction('renewal', -JOB_RENEWAL_FEE, 'completed', `Job #${job.numericId} Renewal`);
  saveJobs();
  updateStorage();
  updateDisplay();
  displayMyJobs();
  showNotification("Job renewed for 30 days!", "success");
  sendTelegramMessage(ADMIN_CHAT_ID, `üîÑ <b>JOB RENEWED</b>\nJob #${job.numericId} | User: ${userData.firstName} (${userData.userId})`);
}

function showJobUpdateForm(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  const formDiv = document.getElementById(`update-form-${jobId}`);
  if (formDiv.style.display !== 'none') { formDiv.style.display = 'none'; return; }

  formDiv.innerHTML = `
    <div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:15px;">
      <h4 style="margin-bottom:15px;color:#ffd700;">Update Job Tasks</h4>
      <div class="input-group">
        <label class="input-label">New Adstera Link</label>
        <input type="text" id="update-adstera-${jobId}" value="${job.adsteraLink}" placeholder="Adstera link">
      </div>
      <div class="input-group">
        <label class="input-label">Number of Tasks</label>
        <select id="update-tasks-${jobId}" onchange="updateJobCostPreview('${jobId}')">
          <option value="1000">1,000</option><option value="2000">2,000</option>
          <option value="3000">3,000</option><option value="5000">5,000</option>
          <option value="7000">7,000</option><option value="10000">10,000</option>
        </select>
      </div>
      <div class="input-group">
        <label class="input-label">Rate per Task</label>
        <input type="number" id="update-rate-${jobId}" value="${job.ratePerTask.toFixed(3)}" min="0.050" step="0.001" oninput="updateJobCostPreview('${jobId}')">
      </div>
      <div class="info-row">
        <span>Total Cost (+10%)</span>
        <span id="update-cost-${jobId}" class="info-value">‡ß≥0.00</span>
      </div>
      <button class="btn" onclick="confirmJobUpdate('${jobId}')">
        <i class="fas fa-check"></i> Confirm Update
      </button>
    </div>
  `;
  formDiv.style.display = 'block';
  updateJobCostPreview(jobId);
}

function updateJobCostPreview(jobId) {
  const tasks = parseInt(document.getElementById(`update-tasks-${jobId}`).value);
  const rate = parseFloat(document.getElementById(`update-rate-${jobId}`).value) || MIN_RATE;
  const cost = calculateJobCost(tasks, rate);
  const el = document.getElementById(`update-cost-${jobId}`);
  if (el) el.textContent = `‡ß≥${cost.total.toFixed(2)}`;
}

function confirmJobUpdate(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;

  const adsteraLink = document.getElementById(`update-adstera-${jobId}`).value.trim();
  const tasks = parseInt(document.getElementById(`update-tasks-${jobId}`).value);
  const rate = parseFloat(document.getElementById(`update-rate-${jobId}`).value);

  if (!adsteraLink) { showNotification("Please enter Adstera link", "error"); return; }
  if (rate < MIN_RATE) { showNotification("Minimum rate is ‡ß≥0.050", "error"); return; }

  const cost = calculateJobCost(tasks, rate);
  if (userData.balance < cost.total) {
    showNotification("Insufficient balance!", "error");
    return;
  }

  userData.balance -= cost.total;
  addTransaction('job_update', -cost.total, 'completed', `Job #${job.numericId} Updated`);

  job.adsteraLink = adsteraLink;
  job.totalTasks = tasks;
  job.ratePerTask = rate;
  job.totalCost = cost.total;
  job.completedTasks = 0;
  job.workers = [];
  job.completedByUsers = [];
  job.status = 'pending';
  job.approvedAdLink = null;
  job.lastRenewed = new Date().toISOString();
  job.nextRenewal = new Date(Date.now() + JOB_CHARGE_DAYS * 24 * 3600 * 1000).toISOString();

  saveJobs();
  updateStorage();
  updateDisplay();
  displayMyJobs();
  showNotification("Job updated! Waiting for admin approval.", "success");

  sendTelegramMessage(ADMIN_CHAT_ID, `
üîÑ <b>JOB UPDATE REQUEST</b>

üÜî Job ID: <code>${job.numericId}</code>
üë§ User: ${job.posterName} (ID: ${userData.userId})
üìä Tasks: ${tasks.toLocaleString()}
üí∞ Rate: ‡ß≥${rate.toFixed(3)}/task
üíµ Total: ‡ß≥${cost.total.toFixed(2)}
üîó New Adstera: ${adsteraLink}
`);
}

// View Ad and complete task
function viewAd(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job || job.status !== 'active') { showNotification("Job not available", "error"); return; }
  if (job.completedTasks >= job.totalTasks) { showNotification("This job is completed", "warning"); return; }

  const today = new Date().toLocaleDateString();
  const userDoneToday = job.workers.some(w => w.userId === userData.userId && new Date(w.completedAt).toLocaleDateString() === today);
  if (userDoneToday) { showNotification("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá ‡¶è‡¶á job ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§", "warning"); return; }

  // Check subscription
  if (isSubscriptionExpired(job)) { showNotification("This job subscription has expired.", "warning"); return; }

  const adLink = job.approvedAdLink || job.adsteraLink;
  const ad = window.open(adLink, "_blank");
  if (!ad) { showNotification("Please allow popups to view ads", "error"); return; }

  // Timer overlay
  const timerDiv = document.createElement('div');
  timerDiv.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.92);color:white;padding:30px;border-radius:20px;z-index:1001;text-align:center;border:2px solid #4CAF50;min-width:220px;`;
  timerDiv.innerHTML = `
    <i class="fas fa-hourglass-half" style="font-size:48px;color:#4CAF50;margin-bottom:15px;display:block;"></i>
    <div style="font-size:48px;font-weight:bold;" id="timer-count">15</div>
    <div style="margin-top:10px;opacity:0.8;">Seconds remaining</div>
    <div style="font-size:12px;margin-top:15px;opacity:0.6;">Please wait in the ad</div>
  `;
  document.body.appendChild(timerDiv);

  let seconds = 15;
  const timer = setInterval(() => {
    seconds--;
    const el = document.getElementById('timer-count');
    if (el) el.textContent = seconds;
    if (seconds <= 0) {
      clearInterval(timer);
      timerDiv.remove();
      if (!ad.closed) ad.close();

      // Credit earnings
      job.completedTasks++;
      job.workers.push({ userId: userData.userId, userName: userData.firstName, completedAt: new Date().toISOString() });

      userData.balance += job.ratePerTask;
      userData.lifetimeEarning += job.ratePerTask;
      userData.totalTasks++;
      addTransaction('task_complete', job.ratePerTask, 'completed', `Task - Job #${job.numericId}`);

      // Referral commission
      if (userData.referredBy) {
        // When user earns, referrer doesn't get commission yet. Commission is on withdrawal.
      }

      if (job.completedTasks >= job.totalTasks) job.status = 'completed';

      saveJobs();
      updateStorage();
      updateDisplay();
      displayAvailableJobs();
      showNotification(`‚úÖ ‡ß≥${job.ratePerTask.toFixed(3)} ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`, "success");
    }
  }, 1000);

  const adCheck = setInterval(() => {
    if (ad.closed && seconds > 0) {
      clearInterval(timer);
      clearInterval(adCheck);
      timerDiv.remove();
      showNotification("You closed the ad too early! Please wait 15 seconds.", "error");
    }
    if (seconds <= 0) clearInterval(adCheck);
  }, 500);
}

// ==================== CALC PAYOUT ====================
function calcPayout() {
  const amount = parseFloat(document.getElementById('withdraw-amount').value);
  const preview = document.getElementById('payout-preview');
  if (isNaN(amount) || amount <= 0) { preview.style.display = 'none'; return; }
  const commission = amount * COMMISSION_RATE;
  const payout = amount - commission;
  document.getElementById('payout-amount').textContent = payout.toFixed(2);
  document.getElementById('commission-amount').textContent = commission.toFixed(2);
  preview.style.display = 'block';
}

// ==================== WITHDRAW ====================
function submitWithdrawal() {
  const amount = parseFloat(document.getElementById('withdraw-amount').value);
  const method = document.getElementById('withdraw-method').value;
  const address = document.getElementById('withdraw-address').value;

  if (isNaN(amount) || amount < 1500) { showNotification("Minimum withdrawal is ‡ß≥1500", "error"); return; }
  if (amount > userData.balance) { showNotification("Insufficient balance", "error"); return; }
  if (!method) { showNotification("Please select a method", "error"); return; }
  if (!address) { showNotification("Please enter payment address", "error"); return; }

  const commission = amount * COMMISSION_RATE;
  const payout = amount - commission;

  const request = {
    id: 'W' + Date.now(),
    userId: userData.userId,
    userName: userData.firstName + ' ' + userData.lastName,
    amount: amount,
    payout: payout,
    commission: commission,
    method: method,
    address: address,
    date: new Date().toISOString(),
    status: 'pending'
  };

  withdrawRequests.push(request);
  saveRequests();

  userData.balance -= amount;
  userData.withdrawHistory.unshift(request);
  addTransaction('withdraw', -amount, 'pending', `Withdrawal (${method})`);

  // Referral commission to referrer
  if (userData.referredBy) {
    const refKey = `userData_${userData.referredBy}`;
    const refUser = JSON.parse(localStorage.getItem(refKey));
    if (refUser) {
      const refCommission = amount * REFERRAL_COMMISSION;
      refUser.balance = (refUser.balance || 0) + refCommission;
      refUser.referralEarnings = (refUser.referralEarnings || 0) + refCommission;
      refUser.referralHistory = refUser.referralHistory || [];
      refUser.referralHistory.unshift({
        userId: userData.userId,
        userName: userData.firstName,
        amount: refCommission,
        date: new Date().toISOString()
      });
      if (!refUser.transactions) refUser.transactions = [];
      refUser.transactions.unshift({ id: 'REF'+Date.now(), type:'referral', amount:refCommission, status:'completed', date:new Date().toISOString(), desc:`Referral from ${userData.firstName}` });
      localStorage.setItem(refKey, JSON.stringify(refUser));
    }
  }

  updateStorage();
  updateDisplay();
  showNotification("Withdrawal request submitted!", "success");

  sendTelegramMessage(ADMIN_CHAT_ID, `
üí∏ <b>NEW WITHDRAWAL REQUEST</b>

üë§ User: ${request.userName} (ID: ${userData.userId})
üí∞ Amount: ‡ß≥${amount.toFixed(2)}
üíµ Payout: ‡ß≥${payout.toFixed(2)} (after 10% = ‡ß≥${commission.toFixed(2)})
üí≥ Method: ${method}
üìß Address: ${address}
üÜî ID: <code>${request.id}</code>
`);

  document.getElementById('withdraw-amount').value = '';
  document.getElementById('withdraw-method').value = '';
  document.getElementById('withdraw-address').value = '';
  document.getElementById('payout-preview').style.display = 'none';
  displayWithdrawHistory();
}

// ==================== DEPOSIT ====================
function submitDeposit() {
  const amount = parseFloat(document.getElementById('deposit-amount').value);
  const method = document.getElementById('deposit-method').value;
  const trxId = document.getElementById('deposit-trx').value;

  if (isNaN(amount) || amount < 100) { showNotification("Minimum deposit is ‡ß≥100", "error"); return; }
  if (!method) { showNotification("Please select payment method", "error"); return; }
  if (!trxId) { showNotification("Please enter transaction ID", "error"); return; }

  const request = {
    id: 'D' + Date.now(),
    userId: userData.userId,
    userName: userData.firstName + ' ' + userData.lastName,
    amount: amount,
    method: method,
    trxId: trxId,
    date: new Date().toISOString(),
    status: 'pending'
  };

  depositRequests.push(request);
  saveRequests();
  userData.depositHistory = userData.depositHistory || [];
  userData.depositHistory.unshift(request);
  updateStorage();

  showNotification("Deposit request submitted! Waiting for approval.", "success");
  sendTelegramMessage(ADMIN_CHAT_ID, `
üí≥ <b>NEW DEPOSIT REQUEST</b>

üë§ User: ${request.userName} (ID: ${userData.userId})
üí∞ Amount: ‡ß≥${amount.toFixed(2)}
üí≥ Method: ${method}
üî¢ TRX ID: ${trxId}
üÜî ID: <code>${request.id}</code>
`);

  document.getElementById('deposit-amount').value = '';
  document.getElementById('deposit-method').value = '';
  document.getElementById('deposit-trx').value = '';
}

// ==================== HISTORY DISPLAYS ====================
function displayWithdrawHistory() {
  const list = document.getElementById('withdrawal-history-list');
  if (!list) return;
  const history = (userData.withdrawHistory || []).slice(0, 5);
  if (history.length === 0) { list.innerHTML = '<div class="empty-history">No withdrawal history</div>'; return; }
  list.innerHTML = history.map(h => `
    <div class="history-item">
      <div>
        <div>${h.method} - ${h.address}</div>
        <div class="history-meta">${new Date(h.date).toLocaleDateString()} &bull; <span class="status-badge status-${h.status}">${h.status}</span></div>
      </div>
      <div class="amount-neg">-‡ß≥${h.amount.toFixed(2)}</div>
    </div>
  `).join('');
}

function displayDepositHistory() {
  const list = document.getElementById('deposit-history-list');
  if (!list) return;
  const history = (userData.depositHistory || []).slice(0, 5);
  if (history.length === 0) { list.innerHTML = '<div class="empty-history">No deposit history</div>'; return; }
  list.innerHTML = history.map(h => `
    <div class="history-item">
      <div>
        <div>${h.method} - TRX: ${h.trxId}</div>
        <div class="history-meta">${new Date(h.date).toLocaleDateString()} &bull; <span class="status-badge status-${h.status}">${h.status}</span></div>
      </div>
      <div class="amount-pos">+‡ß≥${h.amount.toFixed(2)}</div>
    </div>
  `).join('');
}

function displayReferralHistory() {
  const list = document.getElementById('referral-history-list');
  if (!list) return;
  const history = (userData.referralHistory || []).slice(0, 5);
  if (history.length === 0) { list.innerHTML = '<div class="empty-history">No referral earnings yet</div>'; return; }
  list.innerHTML = history.map(h => `
    <div class="history-item">
      <div>
        <div>${h.userName}'s withdrawal</div>
        <div class="history-meta">${new Date(h.date).toLocaleDateString()}</div>
      </div>
      <div class="amount-pos">+‡ß≥${h.amount.toFixed(2)}</div>
    </div>
  `).join('');
}

function displayTransactionHistory() {
  const list = document.getElementById('transaction-history-list');
  if (!list) return;
  const history = (userData.transactions || []).slice(0, 10);
  if (history.length === 0) { list.innerHTML = '<div class="empty-history">No transactions yet</div>'; return; }
  list.innerHTML = history.map(t => `
    <div class="history-item">
      <div>
        <div>${t.desc || t.type}</div>
        <div class="history-meta">${new Date(t.date).toLocaleDateString()}</div>
      </div>
      <div class="${t.amount >= 0 ? 'amount-pos' : 'amount-neg'}">${t.amount >= 0 ? '+' : ''}‡ß≥${Math.abs(t.amount).toFixed(2)}</div>
    </div>
  `).join('');
}

function addTransaction(type, amount, status, desc) {
  if (!userData.transactions) userData.transactions = [];
  userData.transactions.unshift({ id: type + Date.now(), type, amount, status, date: new Date().toISOString(), desc });
}

// ==================== UI ====================
function show(section) {
  const sections = ['home-profile','home-content','earn','post-job','my-jobs','withdraw','deposit','profile-page'];
  sections.forEach(s => document.getElementById(s) && (document.getElementById(s).style.display = 'none'));

  if (section === 'home') {
    document.getElementById('home-profile').style.display = 'block';
    document.getElementById('home-content').style.display = 'block';
  } else if (section === 'earn') {
    document.getElementById('earn').style.display = 'block';
    displayAvailableJobs();
  } else if (section === 'post-job') {
    document.getElementById('post-job').style.display = 'block';
    checkExistingJob();
    updatePricing();
  } else if (section === 'my-jobs') {
    document.getElementById('my-jobs').style.display = 'block';
    displayMyJobs();
  } else if (section === 'withdraw') {
    document.getElementById('withdraw').style.display = 'block';
    displayWithdrawHistory();
    displayDepositHistory();
    updateDisplay();
  } else if (section === 'deposit') {
    document.getElementById('deposit').style.display = 'block';
  } else if (section === 'profile') {
    document.getElementById('profile-page').style.display = 'block';
    displayReferralHistory();
    displayTransactionHistory();
  }

  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  const navMap = { home:'home', earn:'earn', 'post-job':'post-job', 'my-jobs':'my-jobs', withdraw:'home', deposit:'home', profile:'profile' };
  const navId = 'nav-' + (navMap[section] || section);
  const navEl = document.getElementById(navId);
  if (navEl) navEl.classList.add('active');
}

function checkExistingJob() {
  const userActiveJobs = jobs.filter(j => j.posterId === userData.userId && (j.status === 'pending' || j.status === 'active'));
  const warningDiv = document.getElementById('existing-job-warning');
  const formDiv = document.getElementById('job-post-form');
  if (userActiveJobs.length > 0) {
    warningDiv.style.display = 'block';
    formDiv.style.display = 'none';
  } else {
    warningDiv.style.display = 'none';
    formDiv.style.display = 'block';
  }
}

function updateDisplay() {
  if (!userData) return;
  document.getElementById('header-balance').textContent = userData.balance.toFixed(2);
  document.getElementById('user-name').textContent = userData.firstName + (userData.lastName ? ' ' + userData.lastName : '');
  document.getElementById('display-user-id').textContent = userData.userId;
  if (document.getElementById('profile-img')) document.getElementById('profile-img').src = userData.photoUrl;
  document.getElementById('today-earning').textContent = getTodayEarning().toFixed(2);
  document.getElementById('lifetime-earning').textContent = userData.lifetimeEarning.toFixed(2);
  document.getElementById('total-tasks').textContent = userData.totalTasks;
  document.getElementById('referral-count').textContent = userData.referrals || 0;
  document.getElementById('available-balance').textContent = userData.balance.toFixed(2);
  document.getElementById('total-withdrawn').textContent = userData.withdrew.toFixed(2);
  document.getElementById('profile-name').textContent = userData.firstName + (userData.lastName ? ' ' + userData.lastName : '');
  document.getElementById('profile-user-id').textContent = userData.userId;
  if (document.getElementById('profile-page-img')) document.getElementById('profile-page-img').src = userData.photoUrl;
  document.getElementById('profile-username').textContent = '@' + (userData.username || 'user' + userData.userId);
  document.getElementById('member-since').textContent = new Date(userData.joinDate).toLocaleDateString();
  const refLink = `https://t.me/TaskTycoon_Bot?start=ref_${userData.userId}`;
  document.getElementById('referral-link').textContent = refLink;
  document.getElementById('total-referrals').textContent = userData.referrals || 0;
  document.getElementById('referral-earnings').textContent = (userData.referralEarnings || 0).toFixed(2);
}

function getTodayEarning() {
  const today = new Date().toLocaleDateString();
  return (userData.transactions || []).filter(t => t.type === 'task_complete' && new Date(t.date).toLocaleDateString() === today)
    .reduce((sum, t) => sum + t.amount, 0);
}

function updateStorage() {
  localStorage.setItem(`userData_${userData.userId}`, JSON.stringify(userData));
}

function loadRequests() {
  withdrawRequests = JSON.parse(localStorage.getItem('withdrawRequests')) || [];
  depositRequests = JSON.parse(localStorage.getItem('depositRequests')) || [];
}

function saveRequests() {
  localStorage.setItem('withdrawRequests', JSON.stringify(withdrawRequests));
  localStorage.setItem('depositRequests', JSON.stringify(depositRequests));
}

function showNotification(message, type) {
  const notification = document.getElementById('notification');
  document.getElementById('notification-message').textContent = message;
  notification.className = 'notification ' + (type || 'success');
  notification.classList.add('show');
  setTimeout(() => notification.classList.remove('show'), 3500);
}

function copyReferralLink() {
  const refLink = `https://t.me/TaskTycoon_Bot?start=ref_${userData.userId}`;
  navigator.clipboard.writeText(refLink).then(() => showNotification("‚úÖ Referral link copied!", "success")).catch(() => showNotification("Failed to copy", "error"));
}

function openLink(url) {
  if (tg) {
    tg.openLink(url);
  } else {
    window.open(url, '_blank');
  }
}

function openSupport() {
  openLink('https://t.me/YourSupportUsername');
}

// ==================== ADMIN FUNCTIONS ====================
function checkAdminAccess() {
  const adminUsers = [6892959740, 123456789];
  if (userData && adminUsers.includes(userData.userId)) {
    userData.isAdmin = true;
    document.getElementById('admin-access').style.display = 'block';
    updateStorage();
    loadAdminPanel();
  }
}

function toggleAdminPanel() {
  const panel = document.getElementById('admin-panel');
  if (panel.style.display === 'block') {
    panel.style.display = 'none';
  } else {
    panel.style.display = 'block';
    loadAdminPanel();
  }
}

function switchAdminTab(tab) {
  document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('admin-' + tab).classList.add('active');
  event.target.classList.add('active');
}

function loadAdminPanel() {
  // Pending jobs
  const pendingJobs = jobs.filter(j => j.status === 'pending');
  const pjList = document.getElementById('admin-pending-jobs-list');
  pjList.innerHTML = pendingJobs.length === 0 ? '<div class="empty-history">No pending jobs</div>' :
    pendingJobs.map(job => `
      <div class="admin-job-item">
        <div class="admin-job-header">
          <div><strong>Job #${job.numericId}</strong> - ${job.posterName} (ID: ${job.posterId})</div>
          <div>Tasks: ${job.totalTasks.toLocaleString()}</div>
        </div>
        <div>Rate: ‡ß≥${job.ratePerTask.toFixed(3)} | Total: ‡ß≥${job.totalCost.toFixed(2)}</div>
        <div style="word-break:break-all;margin:8px 0;font-size:13px;">Adstera: ${job.adsteraLink}</div>
        <div class="input-group">
          <label>Short/Custom Ad Link (leave empty to use original)</label>
          <input type="text" id="adminlink-${job.id}" class="admin-link-input" placeholder="Short link or leave empty">
        </div>
        <div class="admin-job-actions">
          <button class="btn btn-secondary" onclick="adminApproveJob('${job.id}')"><i class="fas fa-check"></i> Approve</button>
          <button class="btn btn-warning" onclick="adminRejectJob('${job.id}')"><i class="fas fa-times"></i> Reject</button>
        </div>
      </div>
    `).join('');

  // Deposit requests
  const pendingDeposits = depositRequests.filter(r => r.status === 'pending');
  const dpList = document.getElementById('admin-deposit-list');
  dpList.innerHTML = pendingDeposits.length === 0 ? '<div class="empty-history">No pending deposits</div>' :
    pendingDeposits.map(req => `
      <div class="admin-job-item">
        <div>User: ${req.userName} (ID: ${req.userId})</div>
        <div>Amount: ‡ß≥${req.amount.toFixed(2)} | Method: ${req.method} | TRX: ${req.trxId}</div>
        <div class="admin-job-actions">
          <button class="btn btn-secondary" onclick="approveDeposit('${req.id}')">Approve</button>
          <button class="btn btn-warning" onclick="rejectDeposit('${req.id}')">Reject</button>
        </div>
      </div>
    `).join('');

  // Withdraw requests
  const pendingWithdraws = withdrawRequests.filter(r => r.status === 'pending');
  const wdList = document.getElementById('admin-withdraw-list');
  wdList.innerHTML = pendingWithdraws.length === 0 ? '<div class="empty-history">No pending withdrawals</div>' :
    pendingWithdraws.map(req => `
      <div class="admin-job-item">
        <div>User: ${req.userName} (ID: ${req.userId})</div>
        <div>Amount: ‡ß≥${req.amount.toFixed(2)} | Payout: ‡ß≥${req.payout.toFixed(2)} | Method: ${req.method}</div>
        <div>Address: ${req.address}</div>
        <div class="admin-job-actions">
          <button class="btn btn-secondary" onclick="approveWithdraw('${req.id}')">Approve</button>
          <button class="btn btn-warning" onclick="rejectWithdraw('${req.id}')">Reject</button>
        </div>
      </div>
    `).join('');

  // Active jobs
  const activeJobs = jobs.filter(j => j.status === 'active');
  const ajList = document.getElementById('admin-active-jobs-list');
  ajList.innerHTML = activeJobs.length === 0 ? '<div class="empty-history">No active jobs</div>' :
    activeJobs.map(job => `
      <div class="admin-job-item">
        <div><strong>Job #${job.numericId}</strong> - ${job.posterName} | Progress: ${job.completedTasks}/${job.totalTasks}</div>
        <div>Rate: ‡ß≥${job.ratePerTask.toFixed(3)} | Next Renewal: ${new Date(job.nextRenewal).toLocaleDateString()}</div>
        <div style="word-break:break-all;font-size:12px;">Link: ${job.approvedAdLink || job.adsteraLink}</div>
        <div class="input-group">
          <label>Update Ad Link</label>
          <textarea class="admin-link-input" id="updlink-${job.id}" rows="2">${job.approvedAdLink || job.adsteraLink}</textarea>
        </div>
        <button class="btn btn-secondary" style="width:auto;padding:8px 16px;" onclick="adminUpdateLink('${job.id}')">Update Link</button>
      </div>
    `).join('');

  // Expired/not updated jobs
  const expiredJobs = jobs.filter(j => j.status === 'active' && new Date() > new Date(j.nextRenewal));
  const ejList = document.getElementById('admin-expired-jobs-list');
  ejList.innerHTML = expiredJobs.length === 0 ? '<div class="empty-history">No expired jobs</div>' :
    expiredJobs.map(job => `
      <div class="admin-job-item">
        <div><strong>Job #${job.numericId}</strong> - ${job.posterName} (ID: ${job.posterId})</div>
        <div>Expired: ${new Date(job.nextRenewal).toLocaleDateString()}</div>
        <div class="input-group">
          <label>Send Message to User</label>
          <input type="text" id="msg-${job.id}" class="admin-msg-input" placeholder="Type message to send...">
        </div>
        <div class="admin-job-actions">
          <button class="btn btn-secondary" onclick="adminSendMessage('${job.id}')">Send Message</button>
          <button class="btn btn-warning" onclick="adminDeactivateJob('${job.id}')">Deactivate</button>
        </div>
      </div>
    `).join('');
}

function adminApproveJob(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  const customLink = document.getElementById(`adminlink-${jobId}`)?.value?.trim();
  job.status = 'active';
  job.approvedAdLink = customLink || job.adsteraLink;
  saveJobs();
  loadAdminPanel();
  showNotification("Job approved!", "success");
  sendTelegramMessage(job.posterId, `‚úÖ <b>Your Job #${job.numericId} Approved!</b>\n\nYour job is now live with ${job.totalTasks.toLocaleString()} tasks at ‡ß≥${job.ratePerTask.toFixed(3)} each.`);
}

function adminRejectJob(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  job.status = 'rejected';
  const userKey = `userData_${job.posterId}`;
  const user = JSON.parse(localStorage.getItem(userKey));
  if (user) {
    user.balance = (user.balance || 0) + job.totalCost;
    localStorage.setItem(userKey, JSON.stringify(user));
  }
  saveJobs();
  loadAdminPanel();
  showNotification("Job rejected and refunded", "warning");
  sendTelegramMessage(job.posterId, `‚ùå <b>Job #${job.numericId} Rejected</b>\n\n‡ß≥${job.totalCost.toFixed(2)} refunded to your balance.`);
}

function adminUpdateLink(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  const newLink = document.getElementById(`updlink-${jobId}`)?.value?.trim();
  if (newLink) { job.approvedAdLink = newLink; saveJobs(); showNotification("Link updated!", "success"); }
}

function adminSendMessage(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  const msg = document.getElementById(`msg-${jobId}`)?.value?.trim();
  if (!msg) { showNotification("Please enter a message", "error"); return; }
  sendTelegramMessage(job.posterId, `üì¢ <b>Admin Message</b>\n\nJob #${job.numericId}: ${msg}`);
  showNotification("Message sent!", "success");
  document.getElementById(`msg-${jobId}`).value = '';
}

function adminDeactivateJob(jobId) {
  const job = jobs.find(j => j.id === jobId);
  if (!job) return;
  job.status = 'expired';
  saveJobs();
  loadAdminPanel();
  showNotification("Job deactivated", "warning");
}

// Admin approve/reject deposit
window.approveDeposit = function(id) {
  const req = depositRequests.find(r => r.id === id);
  if (!req) return;
  req.status = 'approved';
  const userKey = `userData_${req.userId}`;
  const user = JSON.parse(localStorage.getItem(userKey));
  if (user) {
    user.balance = (user.balance || 0) + req.amount;
    user.deposited = (user.deposited || 0) + req.amount;
    user.depositHistory = user.depositHistory || [];
    const depIdx = user.depositHistory.findIndex(d => d.id === id);
    if (depIdx >= 0) user.depositHistory[depIdx].status = 'approved';
    if (!user.transactions) user.transactions = [];
    user.transactions.unshift({ id:'DEP'+Date.now(), type:'deposit', amount:req.amount, status:'completed', date:new Date().toISOString(), desc:`Deposit (${req.method})` });
    localStorage.setItem(userKey, JSON.stringify(user));
  }
  saveRequests();
  loadAdminPanel();
  showNotification("Deposit approved!", "success");
  sendTelegramMessage(req.userId, `‚úÖ <b>Deposit Approved!</b>\n\n‡ß≥${req.amount.toFixed(2)} added to your balance.`);
};

window.rejectDeposit = function(id) {
  const req = depositRequests.find(r => r.id === id);
  if (!req) return;
  req.status = 'rejected';
  const userKey = `userData_${req.userId}`;
  const user = JSON.parse(localStorage.getItem(userKey));
  if (user) {
    user.depositHistory = user.depositHistory || [];
    const depIdx = user.depositHistory.findIndex(d => d.id === id);
    if (depIdx >= 0) user.depositHistory[depIdx].status = 'rejected';
    localStorage.setItem(userKey, JSON.stringify(user));
  }
  saveRequests();
  loadAdminPanel();
  showNotification("Deposit rejected", "warning");
  sendTelegramMessage(req.userId, `‚ùå <b>Deposit Rejected</b>\n\nYour deposit of ‡ß≥${req.amount.toFixed(2)} was rejected. Contact support.`);
};

window.approveWithdraw = function(id) {
  const req = withdrawRequests.find(r => r.id === id);
  if (!req) return;
  req.status = 'approved';
  const userKey = `userData_${req.userId}`;
  const user = JSON.parse(localStorage.getItem(userKey));
  if (user) {
    user.withdrew = (user.withdrew || 0) + req.amount;
    user.withdrawHistory = user.withdrawHistory || [];
    const wIdx = user.withdrawHistory.findIndex(w => w.id === id);
    if (wIdx >= 0) user.withdrawHistory[wIdx].status = 'approved';
    const txIdx = (user.transactions || []).findIndex(t => t.id === id);
    if (txIdx >= 0) user.transactions[txIdx].status = 'completed';
    localStorage.setItem(userKey, JSON.stringify(user));
  }
  saveRequests();
  loadAdminPanel();
  showNotification("Withdrawal approved!", "success");
  sendTelegramMessage(req.userId, `‚úÖ <b>Withdrawal Approved!</b>\n\n‡ß≥${req.payout.toFixed(2)} sent to your ${req.method} (${req.address}).`);
};

window.rejectWithdraw = function(id) {
  const req = withdrawRequests.find(r => r.id === id);
  if (!req) return;
  req.status = 'rejected';
  const userKey = `userData_${req.userId}`;
  const user = JSON.parse(localStorage.getItem(userKey));
  if (user) {
    user.balance = (user.balance || 0) + req.amount;
    user.withdrawHistory = user.withdrawHistory || [];
    const wIdx = user.withdrawHistory.findIndex(w => w.id === id);
    if (wIdx >= 0) user.withdrawHistory[wIdx].status = 'rejected';
    const txIdx = (user.transactions || []).findIndex(t => t.id === id);
    if (txIdx >= 0) user.transactions[txIdx].status = 'rejected';
    localStorage.setItem(userKey, JSON.stringify(user));
  }
  saveRequests();
  loadAdminPanel();
  showNotification("Withdrawal rejected and refunded", "warning");
  sendTelegramMessage(req.userId, `‚ùå <b>Withdrawal Rejected</b>\n\n‡ß≥${req.amount.toFixed(2)} refunded to your balance. Contact support.`);
};

// ==================== TELEGRAM ====================
async function sendTelegramMessage(chatId, message, buttons = null) {
  try {
    const payload = { chat_id: chatId, text: message, parse_mode: 'HTML' };
    if (buttons) payload.reply_markup = { inline_keyboard: buttons };
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (error) { console.error('Telegram error:', error); }
}

// ==================== EXPOSE ====================
window.show = show;
window.viewAd = viewAd;
window.submitJobPost = submitJobPost;
window.submitWithdrawal = submitWithdrawal;
window.submitDeposit = submitDeposit;
window.copyReferralLink = copyReferralLink;
window.toggleAdminPanel = toggleAdminPanel;
window.switchAdminTab = switchAdminTab;
window.adminApproveJob = adminApproveJob;
window.adminRejectJob = adminRejectJob;
window.adminUpdateLink = adminUpdateLink;
window.adminSendMessage = adminSendMessage;
window.adminDeactivateJob = adminDeactivateJob;
window.updatePricing = updatePricing;
window.calcPayout = calcPayout;
window.renewJob = renewJob;
window.showJobUpdateForm = showJobUpdateForm;
window.updateJobCostPreview = updateJobCostPreview;
window.confirmJobUpdate = confirmJobUpdate;
window.openSupport = openSupport;
window.openLink = openLink;
</script>
</body>
</html>
